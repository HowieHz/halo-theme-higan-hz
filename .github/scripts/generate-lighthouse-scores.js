#!/usr/bin/env node
/**
 * 通过 page-size-report.json 提取 Lighthouse 分类分数并生成 Markdown 报告
 */
import { readFile, writeFile } from "fs/promises";

const MANIFEST = process.env.MANIFEST || "./lighthouse-reports-current/manifest.json";
const OUTPUT_FILE = process.env.OUTPUT_FILE || "./lighthouse-scores.md";

async function main() {
  try {
    const content = await readFile(MANIFEST, "utf8");
    const manifest = JSON.parse(content);

    if (!Array.isArray(manifest)) {
      throw new Error("manifest.json should be an array of entries");
    }

    const lines = [];
    lines.push("# Lighthouse Scores per Page");
    lines.push("");
    lines.push("This report is automatically generated by Lighthouse CI. Scores are 0-100.");
    lines.push("");
    lines.push("| Page | Performance | Accessibility | Best Practices | SEO |");
    lines.push("|------|-----------:|-------------:|--------------:|----:|");

    for (const entry of manifest) {
      const url = entry.url || entry.page || entry.htmlPath || "-";
      const s = entry.summary || {};
      const perf = typeof s.performance === "number" ? Math.round(s.performance * 100) : "-";
      const acc = typeof s.accessibility === "number" ? Math.round(s.accessibility * 100) : "-";
      const bp =
        typeof s["best-practices"] === "number"
          ? Math.round(s["best-practices"] * 100)
          : typeof s.bestPractices === "number"
            ? Math.round(s.bestPractices * 100)
            : "-";
      const seo = typeof s.seo === "number" ? Math.round(s.seo * 100) : "-";

      // Normalize URL: strip scheme+host, keep pathname + search
      let pathOnly = url;
      const u = new URL(url);
      pathOnly = u.pathname + (u.search || "");

      lines.push(`| ${pathOnly} | ${perf} | ${acc} | ${bp} | ${seo} |`);
    }

    await writeFile(OUTPUT_FILE, lines.join("\n"), "utf8");
    console.log(`✓ Lighthouse scores report written to ${OUTPUT_FILE}`);
  } catch (error) {
    console.error("❌ Failed to generate lighthouse scores report:", error.message);
    process.exit(1);
  }
}

main();
