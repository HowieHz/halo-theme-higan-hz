name: Upload Theme Screenshots to Argos

on:
  workflow_run:
    workflows: ["Generate Theme Screenshots"]
    types: [completed]

jobs:
  upload:
    name: Download screenshots and upload to Argos
    # Only run when the generator workflow completed successfully
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read

    steps:
      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Download screenshots
        id: dl-screenshots
        uses: actions/download-artifact@v7
        with:
          pattern: screenshots-*
          merge-multiple: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./screenshots

      - name: Ensure screenshots present
        run: |
          if [ ! -d screenshots ] || [ -z "$(ls -A screenshots 2>/dev/null)" ]; then
            echo "No screenshots downloaded from run ${{ github.event.workflow_run.id }}."
            exit 1
          fi

      - name: Upload to Argos
        continue-on-error: true
        env:
          ARGOS_TOKEN: ${{ secrets.ARGOS_TOKEN }}
        run: |
          if [ -z "$ARGOS_TOKEN" ]; then
            echo "ARGOS_TOKEN not set; skipping upload to Argos"
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              echo "### Argos upload skipped: ARGOS_TOKEN not set" >> "$GITHUB_STEP_SUMMARY"
            fi
            exit 0
          fi

          echo "Uploading screenshots to Argos (artifact: $ARTIFACT_NAME)"
          set -o pipefail
          pnpm dlx @argos-ci/cli upload --token "$ARGOS_TOKEN" ./screenshots/ 2>&1 | tee argos-upload.log
          status=${PIPESTATUS[0]}
          if [ "$status" -ne 0 ]; then
            echo "Argos upload failed with exit code $status"
            tail -n 200 argos-upload.log || true
            if [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
              {
                echo "### Argos upload failed (exit code $status)"
                echo
                echo '```'
                tail -n 200 argos-upload.log || true
                echo '```'
              } >> "$GITHUB_STEP_SUMMARY"
            else
              echo "GITHUB_STEP_SUMMARY not available; see argos-upload.log for details"
            fi
          fi

          # Always succeed this step so the workflow continues. Errors (if any) were written to the step summary.
          exit 0
