name: Page Size Audit

on:
  release:
    types: [published]
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [main]
  workflow_dispatch:
    inputs:
      halo_version:
        description: 'Halo version to test with'
        required: false
        default: '2.21.10'
      theme_version:
        description: 'Theme version to test (e.g., v1.47.0, leave empty to use current code)'
        required: false
        default: ''

jobs:
  audit:
    name: Lighthouse Performance Audit (${{ matrix.ref_name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ref_name: current
            ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          - ref_name: base
            ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.sha }}
      fail-fast: false
    
    steps:
      - name: Checkout ${{ matrix.ref_name }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build theme
        run: pnpm build

      - name: Create build directories
        run: |
          mkdir -p ~/builds/tmp ~/builds/target

      - name: Download or build theme
        run: |
          THEME_VERSION="${{ github.event.inputs.theme_version }}"
          
          if [ -n "$THEME_VERSION" ]; then
            # ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„ä¸»é¢˜
            echo "ä¸‹è½½ä¸»é¢˜ç‰ˆæœ¬: $THEME_VERSION"
            wget https://github.com/HowieHz/halo-theme-higan-hz/releases/download/${THEME_VERSION}/howiehz-higan-cn.zip \
              -O ~/builds/target/howiehz-higan-cn.zip
            
            if [ ! -f ~/builds/target/howiehz-higan-cn.zip ]; then
              echo "âŒ ä¸‹è½½ä¸»é¢˜å¤±è´¥"
              exit 1
            fi
            
            echo "âœ“ ä¸»é¢˜ä¸‹è½½å®Œæˆ: $THEME_VERSION"
          else
            # æ„å»ºå½“å‰ä»£ç 
            echo "ä½¿ç”¨å½“å‰ä»£ç æ„å»ºä¸»é¢˜..."
            cp -r . ~/builds/tmp
            mkdir -p ~/builds/tmp-included
            cd ~/builds/tmp
            cat ${{ github.workspace }}/.github/include-list.txt | xargs -I {} cp -r --parents {} ~/builds/tmp-included/
            cd ~/builds/tmp-included
            zip -9 -r howiehz-higan-cn.zip .
            mv howiehz-higan-cn.zip ~/builds/target/
            
            echo "âœ“ ä¸»é¢˜æ„å»ºå®Œæˆ"
          fi

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Get Java version
        run: |
          JAVA_VERSION=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "JAVA_VERSION=${JAVA_VERSION}" >> $GITHUB_ENV
          echo "âœ“ Java ç‰ˆæœ¬: ${JAVA_VERSION}"

      - name: Download Halo
        run: |
          HALO_VERSION="${{ github.event.inputs.halo_version || '2.21.10' }}"
          # å°è¯•ä» GitHub ä¸‹è½½
          if wget https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar -O ~/halo.jar 2>/dev/null; then
            echo "âœ“ ä» GitHub ä¸‹è½½ Halo æˆåŠŸ"
          else
            echo "âš ï¸  GitHub ä¸‹è½½å¤±è´¥ï¼Œå°è¯•ä»å¤‡ç”¨åœ°å€ä¸‹è½½..."
            wget https://dl.halo.run/release/halo-${HALO_VERSION}.jar -O ~/halo.jar
            echo "âœ“ ä»å¤‡ç”¨åœ°å€ä¸‹è½½ Halo æˆåŠŸ"
          fi
          # å°†å®é™…ä¸‹è½½çš„ç‰ˆæœ¬ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "HALO_VERSION=${HALO_VERSION}" >> $GITHUB_ENV
          echo "âœ“ Halo ç‰ˆæœ¬: ${HALO_VERSION}"

      - name: Create Halo configuration
        run: |
          mkdir -p ~/.halo2
          cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF

      - name: Start Halo in background
        run: |
          nohup java -jar ~/halo.jar \
            --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
            -Dfile.encoding=UTF-8 > ~/halo.log 2>&1 &
          echo $! > ~/halo.pid
          echo "Halo PID: $(cat ~/halo.pid)"

      - name: Wait for Halo to be ready
        run: |
          echo "Waiting for Halo to start..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8090/actuator/health/readiness > /dev/null 2>&1; then
              echo "âœ“ Halo is ready!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 5
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Halo failed to start"
            cat ~/halo.log
            exit 1
          fi

      - name: Initialize Halo system
        run: |
          echo "æ­£åœ¨åˆå§‹åŒ– Halo ç³»ç»Ÿ..."
          
          # è·å– CSRF token
          response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
          csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^"]*\)".*/\1/p')
          
          echo "CSRF Token: $csrf_token"
          
          # æäº¤åˆå§‹åŒ–è¡¨å•
          curl -b /tmp/cookies.txt -X POST \
            http://localhost:8090/system/setup \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "_csrf=${csrf_token}" \
            -d "language=zh-CN" \
            -d "externalUrl=http://localhost:8090" \
            -d "siteTitle=Test Site" \
            -d "username=admin" \
            -d "email=admin@example.com" \
            -d "password=admin" \
            -d "confirmPassword=admin" \
            -L -v
          
          echo "âœ“ Halo ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
          
          # ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
          sleep 10

      - name: Install and activate theme
        run: |
          # ç›´æ¥ä½¿ç”¨ curl ä¸Šä¼ ä¸»é¢˜
          echo "å®‰è£…ä¸»é¢˜..."
          
          # æ£€æŸ¥ Halo æ—¥å¿—ç¡®è®¤åˆå§‹åŒ–å®Œæˆ
          echo "Halo æ—¥å¿—ï¼ˆæœ€å30è¡Œï¼‰:"
          tail -30 ~/halo.log
          echo "---"
          
          # è®¾ç½®å˜é‡
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          
          # ç¡®è®¤æ–‡ä»¶å­˜åœ¨
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "âŒ ä¸»é¢˜æ–‡ä»¶ä¸å­˜åœ¨: $THEME_ZIP_PATH"
            ls -la "${HOME}/builds/target/"
            exit 1
          fi
          
          echo "æ‰¾åˆ°ä¸»é¢˜æ–‡ä»¶: $THEME_ZIP_PATH"
          
          # ä½¿ç”¨ Basic Auth (Halo 2.20+ éœ€è¦å¯ç”¨)
          echo "ä¸Šä¼ ä¸»é¢˜æ–‡ä»¶..."
          
          # æ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯
          echo "è°ƒè¯•ï¼šæµ‹è¯• API è¿æ¥..."
          curl -v http://localhost:8090/actuator/health 2>&1 | head -20
          
          echo "è°ƒè¯•ï¼šå°è¯•ä¸Šä¼ ä¸»é¢˜..."
          response=$(curl -v -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -w "\nHTTP_CODE:%{http_code}\nREDIRECT:%{redirect_url}" \
            2>&1)
          
          echo "å®Œæ•´å“åº”:"
          echo "$response"
          echo "---"
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          redirect_url=$(echo "$response" | grep "REDIRECT:" | cut -d: -f2)
          body=$(echo "$response" | grep -v "^HTTP_CODE:" | grep -v "^REDIRECT:" | grep -v "^\*" | grep -v "^>" | grep -v "^<")
          
          echo "è§£æç»“æœ:"
          echo "HTTP çŠ¶æ€ç : $http_code"
          echo "é‡å®šå‘ URL: $redirect_url"
          echo "å“åº”ä½“: $body"
          
          if [ -z "$http_code" ] || ([ "$http_code" != "200" ] && [ "$http_code" != "201" ]); then
            echo "âŒ ä¸»é¢˜å®‰è£…å¤±è´¥ (HTTP $http_code)"
            echo "å“åº”å†…å®¹: $body"
            if [ "$http_code" = "302" ] && [ -n "$redirect_url" ]; then
              echo "é‡å®šå‘ç›®æ ‡: $redirect_url"
            fi
            exit 1
          fi
          
          echo "âœ“ ä¸»é¢˜å·²å®‰è£…"
          
          # æ¿€æ´»ä¸»é¢˜
          echo "æ¿€æ´»ä¸»é¢˜..."
          sleep 3
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ä¸»é¢˜å·²æ¿€æ´»"
          
          # æ¸…é™¤ç¼“å­˜
          echo "æ¸…é™¤ç¼“å­˜..."
          sleep 2
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ç¼“å­˜å·²æ¸…é™¤"

      - name: Install Lighthouse CI
        run: |
          pnpm add -g @lhci/cli@0.15.x
          echo "LHCI_VERSION=$(lhci --version)" >> $GITHUB_ENV

      - name: Run Lighthouse CI
        run: |
          mkdir -p ./reports
          
          # è¿è¡Œ Lighthouse æµ‹è¯•
          # æ³¨æ„ï¼šä¸æµ‹è¯• 404 é¡µé¢ï¼Œå› ä¸ºå®ƒè¿”å› 404 çŠ¶æ€ç ä¼šå¯¼è‡´ Lighthouse å¤±è´¥
          echo "å¼€å§‹è¿è¡Œ Lighthouse CI æµ‹è¯•..."
          lhci autorun \
            --collect.url=http://localhost:8090/ \
            --collect.url=http://localhost:8090/archives \
            --collect.url=http://localhost:8090/archives/hello-halo \
            --collect.url=http://localhost:8090/tags \
            --collect.url=http://localhost:8090/tags/halo \
            --collect.url=http://localhost:8090/categories \
            --collect.url=http://localhost:8090/categories/default \
            --collect.url=http://localhost:8090/authors/admin \
            --collect.url=http://localhost:8090/about \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --upload.target=temporary-public-storage || {
              echo "âŒ Lighthouse CI æ‰§è¡Œå¤±è´¥"
              echo "æ£€æŸ¥ Lighthouse CI è¾“å‡ºç›®å½•ï¼š"
              ls -la ./.lighthouseci/ || echo ".lighthouseci ç›®å½•ä¸å­˜åœ¨"
              exit 1
            }
          
          echo "âœ“ Lighthouse CI æ‰§è¡Œå®Œæˆ"
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -la ./.lighthouseci/

      - name: Debug - Check Lighthouse files
        if: always()
        run: |
          echo "æ£€æŸ¥ .lighthouseci/ ç›®å½•ï¼š"
          ls -la ./.lighthouseci/ || echo "ç›®å½•ä¸å­˜åœ¨"
          echo "---"
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š"
          pwd
          echo "---"
          echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -la

      - name: Upload Lighthouse raw data (${{ matrix.ref_name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-raw-data-${{ matrix.ref_name }}
          path: ./.lighthouseci/
          include-hidden-files: true
          if-no-files-found: warn

      - name: Generate reports (${{ matrix.ref_name }})
        if: success()
        env:
          OUTPUT_DIR: ./reports
          LIGHTHOUSE_RESULTS_DIR: ./.lighthouseci
          HALO_VERSION: ${{ env.HALO_VERSION }}
          JAVA_VERSION: ${{ env.JAVA_VERSION }}
          THEME_VERSION: ${{ github.event.inputs.theme_version || github.sha }}
          GITHUB_SHA: ${{ github.sha }}
          LHCI_VERSION: ${{ env.LHCI_VERSION }}
          REF_NAME: ${{ matrix.ref_name }}
        run: |
          if [ ! -d "./.lighthouseci" ]; then
            echo "âš ï¸  è­¦å‘Šï¼š.lighthouseci ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          json_count=$(find ./.lighthouseci -name "lhr-*.json" | wc -l)
          if [ "$json_count" -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ° Lighthouse ç»“æœæ–‡ä»¶"
            ls -la ./.lighthouseci/
            exit 1
          fi
          
          echo "æ‰¾åˆ° $json_count ä¸ª Lighthouse ç»“æœæ–‡ä»¶"
          node .github/scripts/generate-report.js

      - name: Upload reports (${{ matrix.ref_name }})
        uses: actions/upload-artifact@v4
        with:
          name: page-size-reports-${{ matrix.ref_name }}
          path: ./reports/

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

      - name: Upload Halo logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: halo-logs-${{ matrix.ref_name }}
          path: ~/halo.log

  compare-and-comment:
    name: Compare and Comment
    needs: audit
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
      
      - name: Download current reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-current
          path: ./reports-current
      
      - name: Download base reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-base
          path: ./reports-base
      
      - name: Generate comparison report
        run: |
          node .github/scripts/compare-reports.js
        env:
          CURRENT_REPORT: ./reports-current/page-size-report.json
          BASE_REPORT: ./reports-base/page-size-report.json
          OUTPUT_FILE: ./comparison-report.md
      
      - name: Comment on PR
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.PR_READ_AND_WRITE_TOKEN }}  # ä½¿ç”¨å…·æœ‰å†™è¯„è®ºæƒé™çš„ä»¤ç‰Œï¼Œå¦‚æœä¸éœ€è¦ bot æçš„ PR ä¹Ÿèƒ½è¯„è®ºçš„è¯å°±ä¸éœ€è¦è¿™ä¸ªäº†
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('./comparison-report.md', 'utf8');
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('âœ“ æˆåŠŸå‘å¸ƒè¯„è®º');
            } catch (error) {
              if (error.status === 403) {
                console.log('âš ï¸  æ— æ³•å‘å¸ƒè¯„è®ºï¼ˆæƒé™ä¸è¶³ï¼‰ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ Dependabot PR ä¸­ã€‚');
                console.log('ğŸ“Š æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸Šä¼ ä¸º artifactï¼Œå¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹ã€‚');
              } else {
                throw error;
              }
            }
