name: Page Size Audit

on:
  push:
    branches: [main]
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches: [main]

jobs:
  audit:
    name: Lighthouse Performance Audit (${{ matrix.ref_name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ref_name: current
            ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      fail-fast: false
    
    steps:
      - name: Checkout ${{ matrix.ref_name }}
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.ref }}

      - name: Copy latest .github scripts
        run: |
          # è·å–æœ€æ–°çš„ .github è„šæœ¬ï¼ˆä»è§¦å‘ workflow çš„åˆ†æ”¯ï¼‰
          # å¯¹äº PR: ä½¿ç”¨ head_ref (æºåˆ†æ”¯)ï¼Œå¯¹äºå…¶ä»–äº‹ä»¶: ä½¿ç”¨ ref_name
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "å·¥ä½œæµåˆ†æ”¯: $BRANCH_NAME"
          
          git fetch origin "$BRANCH_NAME"
          git checkout "origin/$BRANCH_NAME" -- .github/scripts/
          
          echo "âœ“ å·²ä» $BRANCH_NAME åˆ†æ”¯å¤åˆ¶æœ€æ–°çš„ .github/scripts/"

      # ========== é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡(ä¸²è¡Œ,å¾ˆå¿«) ==========
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # ========== é˜¶æ®µ 2: å¹¶è¡Œæ‰§è¡Œ(ä¸»è¦è€—æ—¶éƒ¨åˆ†) ==========
      - name: Parallel Build Theme and Setup Halo
        shell: bash
        run: |
          set -e
          
          # è®°å½•ç¯å¢ƒä¿¡æ¯
          JAVA_VERSION=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "JAVA_VERSION=${JAVA_VERSION}" >> $GITHUB_ENV
          HALO_VERSION="2.22.0-alpha.1"
          echo "HALO_VERSION=${HALO_VERSION}" >> $GITHUB_ENV
          
          mkdir -p ~/logs
          
          # ============ ä»»åŠ¡ 1: ä¸»é¢˜æ„å»º ============
          (
            set -e
            echo "ğŸ“¦ [Theme] å¼€å§‹æ„å»º"
            
            pnpm install
            pnpm build
            
            mkdir -p ~/builds/tmp ~/builds/target
            
            cp -r . ~/builds/tmp
            mkdir -p ~/builds/tmp-included
            cd ~/builds/tmp
            cat "${{ github.workspace }}/.github/include-list.txt" | xargs -I {} cp -r --parents {} ~/builds/tmp-included/
            cd ~/builds/tmp-included
            zip -9 -r howiehz-higan-cn.zip .
            mv howiehz-higan-cn.zip ~/builds/target/
            
            echo "âœ… [Theme] å®Œæˆ"
          ) > ~/logs/theme.log 2>&1 &
          THEME_PID=$!
          
          # ============ ä»»åŠ¡ 2: Halo è®¾ç½® ============
          (
            set -e
            echo "ğŸ”§ [Halo] å¼€å§‹è®¾ç½®"
            
            # ä¸‹è½½ Halo
            # ä¼˜å…ˆä» GitHub Releases ä¸‹è½½ï¼Œå¤±è´¥åˆ™ä»å®˜æ–¹å¤‡ç”¨åœ°å€ä¸‹è½½
            if ! wget -q "https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar" -O ~/halo.jar; then
              wget -q "https://dl.halo.run/release/halo-${HALO_VERSION}.jar" -O ~/halo.jar
            fi
            
            # åˆ›å»ºé…ç½®
            mkdir -p ~/.halo2
            cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF
            
            # å¯åŠ¨ Halo
            nohup java -jar ~/halo.jar \
              --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
              -Dfile.encoding=UTF-8 > ~/logs/halo-startup.log 2>&1 &
            echo $! > ~/halo.pid
            
            # ç­‰å¾…å°±ç»ª
            for i in {1..60}; do
              if curl -sf http://localhost:8090/actuator/health/readiness >/dev/null 2>&1; then
                echo "âœ… [Halo] å°±ç»ª (${i}æ¬¡å°è¯•)"
                break
              fi
              [ $i -eq 60 ] && { echo "âŒ [Halo] è¶…æ—¶"; cat ~/logs/halo-startup.log; exit 1; }
              sleep 1
            done
            
            # åˆå§‹åŒ–ç³»ç»Ÿ
            echo "æ­£åœ¨åˆå§‹åŒ– Halo ç³»ç»Ÿ..."
            response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
            csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^"]*\)".*/\1/p')
            
            curl -b /tmp/cookies.txt -X POST \
              http://localhost:8090/system/setup \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "_csrf=${csrf_token}" \
              -d "language=zh-CN" \
              -d "externalUrl=http://localhost:8090" \
              -d "siteTitle=0" \
              -d "username=admin" \
              -d "email=admin@example.com" \
              -d "password=admin" \
              -d "confirmPassword=admin" \
              -L -s > /dev/null

            echo "âœ… [Halo] å®Œæˆ"
          ) > ~/logs/halo.log 2>&1 &
          HALO_PID=$!
          
          # ============ ç­‰å¾…å¹¶æ£€æŸ¥ç»“æœ ============
          echo "â³ ç­‰å¾…å¹¶è¡Œä»»åŠ¡..."
          
          wait $THEME_PID
          THEME_CODE=$?
          wait $HALO_PID
          HALO_CODE=$?
          
          if [ $THEME_CODE -ne 0 ]; then
            echo "âŒ ä¸»é¢˜æ„å»ºå¤±è´¥"
            cat ~/logs/theme.log
            exit 1
          fi
          
          if [ $HALO_CODE -ne 0 ]; then
            echo "âŒ Halo è®¾ç½®å¤±è´¥"
            cat ~/logs/halo.log
            exit 1
          fi
          
          echo "ğŸ‰ å¹¶è¡Œä»»åŠ¡å…¨éƒ¨æˆåŠŸ!"

      # ========== é˜¶æ®µ 3: åç»­æ­¥éª¤(ä¸²è¡Œ) ==========
      - name: Install and activate theme
        run: |
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "âŒ ä¸»é¢˜æ–‡ä»¶ä¸å­˜åœ¨: $THEME_ZIP_PATH"
            exit 1
          fi
          
          echo "å®‰è£…ä¸»é¢˜..."
          response=$(curl -v -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -w "\nHTTP_CODE:%{http_code}" \
            2>&1)
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ -z "$http_code" ] || ([ "$http_code" != "200" ] && [ "$http_code" != "201" ]); then
            echo "âŒ ä¸»é¢˜å®‰è£…å¤±è´¥ (HTTP $http_code)"
            echo "$response"
            exit 1
          fi
          
          echo "âœ“ ä¸»é¢˜å·²å®‰è£…"
          
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ä¸»é¢˜å·²æ¿€æ´»"
          
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ç¼“å­˜å·²æ¸…é™¤"

      - name: Disable Halo plugins
        shell: bash
        run: |
          set -e
          
          echo "ç¦ç”¨æ’ä»¶: PluginCommentWidget, PluginSearchWidget"
          
          PIDS=()
          
          for plugin in PluginCommentWidget PluginSearchWidget; do
            (
              echo "ğŸ”§ ç¦ç”¨ ${plugin}"
              if curl -sX PUT \
                "http://localhost:8090/apis/api.console.halo.run/v1alpha1/plugins/${plugin}/plugin-state" \
                -u admin:admin \
                -H "Content-Type: application/json" \
                -d '{"async":false,"enabled":false}'; then
                echo "âœ… ${plugin} ç¦ç”¨æˆåŠŸ"
              else
                echo "âš ï¸  ${plugin} ç¦ç”¨å¤±è´¥(å·²å¿½ç•¥)"
              fi
            ) &
            PIDS+=($!)
          done
          
          echo "â³ ç­‰å¾…æ’ä»¶ç¦ç”¨ä»»åŠ¡..."
          
          for pid in "${PIDS[@]}"; do
            wait $pid || true
          done
          
          echo "ğŸ‰ æ’ä»¶ç¦ç”¨å®Œæˆ"

      - name: Run Lighthouse CI and Playwright screenshots in parallel
        shell: bash
        run: |
          set -e
          mkdir -p ~/logs

          # ============ Task A: Lighthouse CI ============
          (
            set -e
            echo "ğŸ“¦ [LHCI] Install LHCI"
            if ! command -v lhci >/dev/null 2>&1; then
              pnpm add -g @lhci/cli@0.15.x || echo "âš ï¸  LHCI install failed, continuing"
            else
              echo "âœ“ lhci already installed"
            fi
            echo "LHCI_VERSION=$(lhci --version 2>/dev/null || echo 'unknown')" >> $GITHUB_ENV

            echo "ğŸš€ [LHCI] Run Lighthouse CI"
            mkdir -p ./reports
            lhci autorun \
              --collect.url=http://localhost:8090/ \
              --collect.url=http://localhost:8090/archives \
              --collect.url=http://localhost:8090/archives/hello-halo \
              --collect.url=http://localhost:8090/tags \
              --collect.url=http://localhost:8090/tags/halo \
              --collect.url=http://localhost:8090/categories \
              --collect.url=http://localhost:8090/categories/default \
              --collect.url=http://localhost:8090/authors/admin \
              --collect.url=http://localhost:8090/about \
              --collect.numberOfRuns=1 \
              --collect.settings.preset=desktop \
              --collect.settings.throttling.rttMs=0 \
              --collect.settings.throttling.throughputKbps=0 \
              --collect.settings.throttling.cpuSlowdownMultiplier=1 \
              --collect.settings.throttling.requestLatencyMs=0 \
              --collect.settings.throttling.downloadThroughputKbps=0 \
              --collect.settings.throttling.uploadThroughputKbps=0 \
              --upload.target=filesystem \
              --upload.outputDir=.lighthouseci || {
                echo "âŒ [LHCI] Lighthouse CI failed"
                ls -la ./.lighthouseci/ || echo ".lighthouseci directory not found"
                exit 1
              }
            echo "âœ… [LHCI] Complete"
          ) > ~/logs/lhci.log 2>&1 &
          LHCI_PID=$!

          # ============ Task B: Playwright + Argos ============
          (
            set -e
            echo "ğŸ“¦ [Playwright] Install Playwright and Argos"
            if ! command -v argos >/dev/null 2>&1; then
              pnpm add -g @argos-ci/cli || echo "âš ï¸  Argos CLI install failed, continuing"
            else
              echo "âœ“ argos already installed"
            fi

            if ! pnpm exec -- playwright --version >/dev/null 2>&1; then
              pnpm add -w -D playwright @argos-ci/playwright || echo "âš ï¸  Playwright install failed, continuing"
            else
              echo "âœ“ playwright already available via pnpm exec"
            fi

            pnpm exec playwright install --with-deps chromium

            echo "ğŸ“¸ [Playwright] Take screenshots"
            mkdir -p screenshots
            node --input-type=module -e "
            import { chromium } from 'playwright';
            import { argosScreenshot } from '@argos-ci/playwright';

            (async () => {
              const browser = await chromium.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const context = await browser.newContext({ baseURL: 'http://localhost:8090' });
              const page = await context.newPage();

              const pages = [
                { name: 'home', path: '/' },
                { name: 'archives', path: '/archives' },
                { name: 'archives-hello-halo', path: '/archives/hello-halo' },
                { name: 'tags', path: '/tags' },
                { name: 'tags-halo', path: '/tags/halo' },
                { name: 'categories', path: '/categories' },
                { name: 'categories-default', path: '/categories/default' },
                { name: 'author-admin', path: '/authors/admin' },
                { name: 'about', path: '/about' }
              ];

              for (const { name, path } of pages) {
                await page.goto(path);
                await argosScreenshot(page, name);
              }

              await browser.close();
            })();
            "

            echo "â˜ï¸ [Playwright] Upload screenshots to Argos"
            if [ -n "${{ secrets.ARGOS_TOKEN }}" ]; then
              argos upload --token ${{ secrets.ARGOS_TOKEN }} ./screenshots/ || echo "âš ï¸ Argos upload failed"
            else
              echo "â„¹ï¸  ARGOS_TOKEN not set; skipping Argos upload"
            fi
            echo "âœ… [Playwright] Complete"
          ) > ~/logs/playwright.log 2>&1 &
          PLAY_PID=$!

          echo "â³ Waiting parallel tasks..."
          wait $LHCI_PID
          LHCI_CODE=$?
          wait $PLAY_PID
          PLAY_CODE=$?

          if [ $LHCI_CODE -ne 0 ]; then
            echo "âŒ LHCI task failed. Log output:"
            sed -n '1,200p' ~/logs/lhci.log || true
            exit $LHCI_CODE
          fi

          if [ $PLAY_CODE -ne 0 ]; then
            echo "âŒ Playwright task failed. Log output:"
            sed -n '1,200p' ~/logs/playwright.log || true
            exit $PLAY_CODE
          fi

          echo "ğŸ‰ Both LHCI and Playwright tasks succeeded"
      
      - name: Upload screenshots (${{ matrix.ref_name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.ref_name }}
          path: ./screenshots/
          include-hidden-files: true
          if-no-files-found: warn
        
      - name: Upload Lighthouse raw data (${{ matrix.ref_name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-raw-data-${{ matrix.ref_name }}
          path: ./.lighthouseci/
          include-hidden-files: true
          if-no-files-found: warn

      - name: Generate reports (${{ matrix.ref_name }})
        if: success()
        env:
          OUTPUT_DIR: ./reports
          LIGHTHOUSE_RESULTS_DIR: ./.lighthouseci
          HALO_VERSION: ${{ env.HALO_VERSION }}
          JAVA_VERSION: ${{ env.JAVA_VERSION }}
          THEME_VERSION: ${{ matrix.ref }}
          GITHUB_SHA: ${{ github.sha }}
          LHCI_VERSION: ${{ env.LHCI_VERSION }}
          REF_NAME: ${{ matrix.ref_name }}
        run: |
          if [ ! -d "./.lighthouseci" ]; then
            echo "âš ï¸  è­¦å‘Šï¼š.lighthouseci ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          json_count=$(find ./.lighthouseci -name "lhr-*.json" | wc -l)
          if [ "$json_count" -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ° Lighthouse ç»“æœæ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ° $json_count ä¸ª Lighthouse ç»“æœæ–‡ä»¶"
          node .github/scripts/generate-report.js

      - name: Upload reports (${{ matrix.ref_name }})
        uses: actions/upload-artifact@v4
        with:
          name: page-size-reports-${{ matrix.ref_name }}
          path: ./reports/

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

      - name: Upload Halo logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: halo-logs-${{ matrix.ref_name }}
          path: ~/logs/

  audit-base:
    name: Lighthouse Performance Audit (${{ matrix.ref_name }})
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ref_name: base
            ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.sha }}
      fail-fast: false
    steps:
      - name: Checkout ${{ matrix.ref_name }}
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.ref }}

      - name: Copy latest .github scripts
        run: |
          # è·å–æœ€æ–°çš„ .github è„šæœ¬ï¼ˆä»è§¦å‘ workflow çš„åˆ†æ”¯ï¼‰
          # å¯¹äº PR: ä½¿ç”¨ head_ref (æºåˆ†æ”¯)ï¼Œå¯¹äºå…¶ä»–äº‹ä»¶: ä½¿ç”¨ ref_name
          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
          echo "å·¥ä½œæµåˆ†æ”¯: $BRANCH_NAME"
          
          git fetch origin "$BRANCH_NAME"
          git checkout "origin/$BRANCH_NAME" -- .github/scripts/
          
          echo "âœ“ å·²ä» $BRANCH_NAME åˆ†æ”¯å¤åˆ¶æœ€æ–°çš„ .github/scripts/"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Parallel Build Theme and Setup Halo
        shell: bash
        run: |
          set -e
          
          # è®°å½•ç¯å¢ƒä¿¡æ¯
          JAVA_VERSION=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "JAVA_VERSION=${JAVA_VERSION}" >> $GITHUB_ENV
          HALO_VERSION="2.22.0-alpha.1"
          echo "HALO_VERSION=${HALO_VERSION}" >> $GITHUB_ENV
          
          mkdir -p ~/logs
          
          # ============ ä»»åŠ¡ 1: ä¸»é¢˜æ„å»º ============
          (
            set -e
            echo "ğŸ“¦ [Theme] å¼€å§‹æ„å»º"
            
            pnpm install
            pnpm build
            
            mkdir -p ~/builds/tmp ~/builds/target
            
            cp -r . ~/builds/tmp
            mkdir -p ~/builds/tmp-included
            cd ~/builds/tmp
            cat "${{ github.workspace }}/.github/include-list.txt" | xargs -I {} cp -r --parents {} ~/builds/tmp-included/
            cd ~/builds/tmp-included
            zip -9 -r howiehz-higan-cn.zip .
            mv howiehz-higan-cn.zip ~/builds/target/
            
            echo "âœ… [Theme] å®Œæˆ"
          ) > ~/logs/theme.log 2>&1 &
          THEME_PID=$!
          
          # ============ ä»»åŠ¡ 2: Halo è®¾ç½® ============
          (
            set -e
            echo "ğŸ”§ [Halo] å¼€å§‹è®¾ç½®"
            
            if ! wget -q "https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar" -O ~/halo.jar; then
              wget -q "https://dl.halo.run/release/halo-${HALO_VERSION}.jar" -O ~/halo.jar
            fi
            
            mkdir -p ~/.halo2
            cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF
            
            nohup java -jar ~/halo.jar \
              --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
              -Dfile.encoding=UTF-8 > ~/logs/halo-startup.log 2>&1 &
            echo $! > ~/halo.pid
            
            for i in {1..60}; do
              if curl -sf http://localhost:8090/actuator/health/readiness >/dev/null 2>&1; then
                echo "âœ… [Halo] å°±ç»ª (${i}æ¬¡å°è¯•)"
                break
              fi
              [ $i -eq 60 ] && { echo "âŒ [Halo] è¶…æ—¶"; cat ~/logs/halo-startup.log; exit 1; }
              sleep 1
            done
            
            response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
            csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^\"]*\)".*/\1/p')
            
            curl -b /tmp/cookies.txt -X POST \
              http://localhost:8090/system/setup \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "_csrf=${csrf_token}" \
              -d "language=zh-CN" \
              -d "externalUrl=http://localhost:8090" \
              -d "siteTitle=0" \
              -d "username=admin" \
              -d "email=admin@example.com" \
              -d "password=admin" \
              -d "confirmPassword=admin" \
              -L -s > /dev/null

            echo "âœ… [Halo] å®Œæˆ"
          ) > ~/logs/halo.log 2>&1 &
          HALO_PID=$!

          echo "â³ ç­‰å¾…å¹¶è¡Œä»»åŠ¡..."
          
          wait $THEME_PID
          THEME_CODE=$?
          wait $HALO_PID
          HALO_CODE=$?
          
          if [ $THEME_CODE -ne 0 ]; then
            echo "âŒ ä¸»é¢˜æ„å»ºå¤±è´¥"
            cat ~/logs/theme.log
            exit 1
          fi
          
          if [ $HALO_CODE -ne 0 ]; then
            echo "âŒ Halo è®¾ç½®å¤±è´¥"
            cat ~/logs/halo.log
            exit 1
          fi
          
          echo "ğŸ‰ å¹¶è¡Œä»»åŠ¡å…¨éƒ¨æˆåŠŸ!"

      - name: Install and activate theme
        run: |
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "âŒ ä¸»é¢˜æ–‡ä»¶ä¸å­˜åœ¨: $THEME_ZIP_PATH"
            exit 1
          fi
          
          echo "å®‰è£…ä¸»é¢˜..."
          response=$(curl -v -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -w "\nHTTP_CODE:%{http_code}" \
            2>&1)
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ -z "$http_code" ] || ([ "$http_code" != "200" ] && [ "$http_code" != "201" ]); then
            echo "âŒ ä¸»é¢˜å®‰è£…å¤±è´¥ (HTTP $http_code)"
            echo "$response"
            exit 1
          fi
          
          echo "âœ“ ä¸»é¢˜å·²å®‰è£…"
          
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ä¸»é¢˜å·²æ¿€æ´»"
          
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ç¼“å­˜å·²æ¸…é™¤"

      - name: Disable Halo plugins
        shell: bash
        run: |
          set -e
          
          echo "ç¦ç”¨æ’ä»¶: PluginCommentWidget, PluginSearchWidget"
          
          PIDS=()
          
          for plugin in PluginCommentWidget PluginSearchWidget; do
            (
              echo "ğŸ”§ ç¦ç”¨ ${plugin}"
              if curl -sX PUT \
                "http://localhost:8090/apis/api.console.halo.run/v1alpha1/plugins/${plugin}/plugin-state" \
                -u admin:admin \
                -H "Content-Type: application/json" \
                -d '{"async":false,"enabled":false}'; then
                echo "âœ… ${plugin} ç¦ç”¨æˆåŠŸ"
              else
                echo "âš ï¸  ${plugin} ç¦ç”¨å¤±è´¥(å·²å¿½ç•¥)"
              fi
            ) &
            PIDS+=($!)
          done
          
          echo "â³ ç­‰å¾…æ’ä»¶ç¦ç”¨ä»»åŠ¡..."
          
          for pid in "${PIDS[@]}"; do
            wait $pid || true
          done
          
          echo "ğŸ‰ æ’ä»¶ç¦ç”¨å®Œæˆ"

      - name: Run Lighthouse CI and Playwright screenshots in parallel
        shell: bash
        run: |
          set -e
          mkdir -p ~/logs

          # ============ Task A: Lighthouse CI ============
          (
            set -e
            echo "ğŸ“¦ [LHCI] Install LHCI"
            if ! command -v lhci >/dev/null 2>&1; then
              pnpm add -g @lhci/cli@0.15.x || echo "âš ï¸  LHCI install failed, continuing"
            else
              echo "âœ“ lhci already installed"
            fi
            echo "LHCI_VERSION=$(lhci --version 2>/dev/null || echo 'unknown')" >> $GITHUB_ENV

            echo "ğŸš€ [LHCI] Run Lighthouse CI"
            mkdir -p ./reports
            lhci autorun \
              --collect.url=http://localhost:8090/ \
              --collect.url=http://localhost:8090/archives \
              --collect.url=http://localhost:8090/archives/hello-halo \
              --collect.url=http://localhost:8090/tags \
              --collect.url=http://localhost:8090/tags/halo \
              --collect.url=http://localhost:8090/categories \
              --collect.url=http://localhost:8090/categories/default \
              --collect.url=http://localhost:8090/authors/admin \
              --collect.url=http://localhost:8090/about \
              --collect.numberOfRuns=1 \
              --collect.settings.preset=desktop \
              --collect.settings.throttling.rttMs=0 \
              --collect.settings.throttling.throughputKbps=0 \
              --collect.settings.throttling.cpuSlowdownMultiplier=1 \
              --collect.settings.throttling.requestLatencyMs=0 \
              --collect.settings.throttling.downloadThroughputKbps=0 \
              --collect.settings.throttling.uploadThroughputKbps=0 \
              --upload.target=filesystem \
              --upload.outputDir=.lighthouseci || {
                echo "âŒ [LHCI] Lighthouse CI failed"
                ls -la ./.lighthouseci/ || echo ".lighthouseci directory not found"
                exit 1
              }
            echo "âœ… [LHCI] Complete"
          ) > ~/logs/lhci.log 2>&1 &
          LHCI_PID=$!

          # ============ Task B: Playwright + Argos ============
          (
            set -e
            echo "ğŸ“¦ [Playwright] Install Playwright and Argos"
            if ! command -v argos >/dev/null 2>&1; then
              pnpm add -g @argos-ci/cli || echo "âš ï¸  Argos CLI install failed, continuing"
            else
              echo "âœ“ argos already installed"
            fi

            if ! pnpm exec -- playwright --version >/dev/null 2>&1; then
              pnpm add -w -D playwright @argos-ci/playwright || echo "âš ï¸  Playwright install failed, continuing"
            else
              echo "âœ“ playwright already available via pnpm exec"
            fi

            pnpm exec playwright install --with-deps chromium

            echo "ğŸ“¸ [Playwright] Take screenshots"
            mkdir -p screenshots
            node --input-type=module -e "
            import { chromium } from 'playwright';
            import { argosScreenshot } from '@argos-ci/playwright';

            (async () => {
              const browser = await chromium.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });
              const context = await browser.newContext({ baseURL: 'http://localhost:8090' });
              const page = await context.newPage();

              const pages = [
                { name: 'home', path: '/' },
                { name: 'archives', path: '/archives' },
                { name: 'archives-hello-halo', path: '/archives/hello-halo' },
                { name: 'tags', path: '/tags' },
                { name: 'tags-halo', path: '/tags/halo' },
                { name: 'categories', path: '/categories' },
                { name: 'categories-default', path: '/categories/default' },
                { name: 'author-admin', path: '/authors/admin' },
                { name: 'about', path: '/about' }
              ];

              for (const { name, path } of pages) {
                await page.goto(path);
                await argosScreenshot(page, name);
              }

              await browser.close();
            })();
            "

            echo "â˜ï¸ [Playwright] Upload screenshots to Argos"
            if [ -n "${{ secrets.ARGOS_TOKEN }}" ]; then
              argos upload --token ${{ secrets.ARGOS_TOKEN }} ./screenshots/ || echo "âš ï¸ Argos upload failed"
            else
              echo "â„¹ï¸  ARGOS_TOKEN not set; skipping Argos upload"
            fi
            echo "âœ… [Playwright] Complete"
          ) > ~/logs/playwright.log 2>&1 &
          PLAY_PID=$!

          echo "â³ Waiting parallel tasks..."
          wait $LHCI_PID
          LHCI_CODE=$?
          wait $PLAY_PID
          PLAY_CODE=$?

          if [ $LHCI_CODE -ne 0 ]; then
            echo "âŒ LHCI task failed. Log output:"
            sed -n '1,200p' ~/logs/lhci.log || true
            exit $LHCI_CODE
          fi

          if [ $PLAY_CODE -ne 0 ]; then
            echo "âŒ Playwright task failed. Log output:"
            sed -n '1,200p' ~/logs/playwright.log || true
            exit $PLAY_CODE
          fi

          echo "ğŸ‰ Both LHCI and Playwright tasks succeeded"
      
      - name: Upload screenshots (${{ matrix.ref_name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.ref_name }}
          path: ./screenshots/
          include-hidden-files: true
          if-no-files-found: warn
        
      - name: Upload Lighthouse raw data (${{ matrix.ref_name }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-raw-data-${{ matrix.ref_name }}
          path: ./.lighthouseci/
          include-hidden-files: true
          if-no-files-found: warn

      - name: Generate reports (${{ matrix.ref_name }})
        if: success()
        env:
          OUTPUT_DIR: ./reports
          LIGHTHOUSE_RESULTS_DIR: ./.lighthouseci
          HALO_VERSION: ${{ env.HALO_VERSION }}
          JAVA_VERSION: ${{ env.JAVA_VERSION }}
          THEME_VERSION: ${{ matrix.ref }}
          GITHUB_SHA: ${{ github.sha }}
          LHCI_VERSION: ${{ env.LHCI_VERSION }}
          REF_NAME: ${{ matrix.ref_name }}
        run: |
          if [ ! -d "./.lighthouseci" ]; then
            echo "âš ï¸  è­¦å‘Šï¼š.lighthouseci ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          json_count=$(find ./.lighthouseci -name "lhr-*.json" | wc -l)
          if [ "$json_count" -eq 0 ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰æ‰¾åˆ° Lighthouse ç»“æœæ–‡ä»¶"
            exit 1
          fi
          
          echo "æ‰¾åˆ° $json_count ä¸ª Lighthouse ç»“æœæ–‡ä»¶"
          node .github/scripts/generate-report.js

      - name: Upload reports (${{ matrix.ref_name }})
        uses: actions/upload-artifact@v4
        with:
          name: page-size-reports-${{ matrix.ref_name }}
          path: ./reports/

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

      - name: Upload Halo logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: halo-logs-${{ matrix.ref_name }}
          path: ~/logs/

  compare-and-comment:
    name: Compare and Comment
    needs: [audit, audit-base]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:  # use permissions because use of pr-comments
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
      
      - name: Download current reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-current
          path: ./reports-current
      
      - name: Download base reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-base
          path: ./reports-base
      
      - name: Generate comparison report
        run: |
          node .github/scripts/compare-reports.js
        env:
          CURRENT_REPORT: ./reports-current/page-size-report.json
          BASE_REPORT: ./reports-base/page-size-report.json
          OUTPUT_FILE: ./comparison-report.md
      
      - name: Comment on PR
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('./comparison-report.md', 'utf8');
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('âœ“ æˆåŠŸå‘å¸ƒè¯„è®º');
            } catch (error) {
              if (error.status === 403) {
                console.log('âš ï¸  æ— æ³•å‘å¸ƒè¯„è®ºï¼ˆæƒé™ä¸è¶³ï¼‰ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ Dependabot æˆ–å…¶ä»– bot åˆ›å»ºçš„ PR ä¸­ã€‚');
                console.log('ğŸ“Š æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸Šä¼ ä¸º artifactï¼Œå¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹ã€‚');
              } else {
                throw error;
              }
            }
