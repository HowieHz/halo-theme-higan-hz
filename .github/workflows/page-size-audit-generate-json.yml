name: "Page Size Audit: Generate JSON"

on:
  workflow_dispatch:
    inputs:
      start_version:
        description: 'èµ·å§‹ç‰ˆæœ¬ (ä¾‹å¦‚: v1.45.0ï¼Œç•™ç©ºè¡¨ç¤º v1.0.0)'
        required: false
        default: 'v1.0.0'
      end_version:
        description: 'ç»“æŸç‰ˆæœ¬ (ä¾‹å¦‚: v1.47.0ï¼Œç•™ç©ºè¡¨ç¤ºæœ€æ–°ç‰ˆæœ¬)'
        required: false
        default: ''
      create_pr:
        description: 'æ˜¯å¦åˆ›å»º PR æäº¤æ•°æ®æ–‡ä»¶'
        required: true
        default: false
        type: boolean
  release:
    types: [published]

jobs:
  # ç¬¬ä¸€æ­¥ï¼šè·å–è¦æµ‹è¯•çš„ç‰ˆæœ¬åˆ—è¡¨
  get-versions:
    name: Get Version List
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version list
        id: get-versions
        uses: actions/github-script@v7
        with:
          script: |
            let startVersion, endVersion;
            
            if ('${{ github.event_name }}' === 'release') {
              const releaseVersion = '${{ github.event.release.tag_name }}';
              startVersion = releaseVersion;
              endVersion = releaseVersion;
              console.log(`Release è§¦å‘: æµ‹è¯•ç‰ˆæœ¬ ${releaseVersion}`);
            } else {
              startVersion = '${{ github.event.inputs.start_version }}' || 'v1.0.0';
              endVersion = '${{ github.event.inputs.end_version }}' || '';
            }
            
            // è·å–æ‰€æœ‰ releasesï¼ˆæ”¯æŒåˆ†é¡µï¼‰
            console.log('æ­£åœ¨è·å–æ‰€æœ‰ releases...');
            const releases = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              releases.push(...data);
              console.log(`å·²è·å–ç¬¬ ${page} é¡µï¼Œå…± ${data.length} ä¸ª releases`);
              
              if (data.length < 100) {
                hasMore = false;
              } else {
                page++;
              }
            }
            
            console.log(`æ€»å…±è·å– ${releases.length} ä¸ª releases`);
            
            // è¿‡æ»¤é¢„å‘å¸ƒç‰ˆæœ¬ï¼ˆä½¿ç”¨ GitHub API çš„ prerelease å­—æ®µï¼‰
            const stableReleases = releases.filter(r => {
              if (r.prerelease) {
                console.log(`âŠ˜ è·³è¿‡é¢„å‘å¸ƒç‰ˆæœ¬: ${r.tag_name}`);
                return false;
              }
              return true;
            });
            
            console.log(`è¿‡æ»¤åå¾—åˆ° ${stableReleases.length} ä¸ªç¨³å®šç‰ˆæœ¬`);
            
            // æŒ‰è¯­ä¹‰åŒ–ç‰ˆæœ¬æ’åºï¼ˆä»æ—§åˆ°æ–°ï¼‰
            const parseVersion = (version) => {
              const match = version.match(/^v?(\d+)\.(\d+)\.(\d+)(?:-(.+))?$/);
              if (!match) return null;
              const [, major, minor, patch] = match;
              return {
                major: parseInt(major, 10),
                minor: parseInt(minor, 10),
                patch: parseInt(patch, 10)
              };
            };
            
            stableReleases.sort((a, b) => {
              const versionA = parseVersion(a.tag_name);
              const versionB = parseVersion(b.tag_name);
              
              if (!versionA || !versionB) {
                console.warn(`âš ï¸  æ— æ³•è§£æç‰ˆæœ¬å·: ${a.tag_name} æˆ– ${b.tag_name}`);
                return 0;
              }
              
              if (versionA.major !== versionB.major) return versionA.major - versionB.major;
              if (versionA.minor !== versionB.minor) return versionA.minor - versionB.minor;
              return versionA.patch - versionB.patch;
            });
            
            // æ‰¾åˆ°ç‰ˆæœ¬èŒƒå›´
            const startIndex = stableReleases.findIndex(r => r.tag_name === startVersion);
            const endIndex = endVersion ? stableReleases.findIndex(r => r.tag_name === endVersion) : stableReleases.length - 1;
            
            if (startIndex === -1) {
              core.setFailed(`æ‰¾ä¸åˆ°èµ·å§‹ç‰ˆæœ¬: ${startVersion}ï¼Œå¯ç”¨çš„ç¨³å®šç‰ˆæœ¬: ${stableReleases.slice(0, 10).map(r => r.tag_name).join(', ')}...`);
              return;
            }
            if (endVersion && endIndex === -1) {
              core.setFailed(`æ‰¾ä¸åˆ°ç»“æŸç‰ˆæœ¬: ${endVersion}`);
              return;
            }
            
            // æå–ç‰ˆæœ¬åˆ—è¡¨ï¼ˆä»èµ·å§‹åˆ°ç»“æŸï¼‰
            const versionList = stableReleases
              .slice(startIndex, endIndex + 1)
              .map(r => r.tag_name);
            
            console.log(`æ‰¾åˆ° ${versionList.length} ä¸ªç‰ˆæœ¬:`, versionList);
            core.setOutput('versions', JSON.stringify(versionList));

  # ç¬¬äºŒæ­¥ï¼šå¹¶è¡Œè¿è¡Œæ¯ä¸ªç‰ˆæœ¬çš„æµ‹è¯•
  test-versions:
    name: Test ${{ matrix.version }}
    needs: get-versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(needs.get-versions.outputs.versions) }}
      fail-fast: false  # å³ä½¿æŸä¸ªç‰ˆæœ¬å¤±è´¥ï¼Œç»§ç»­æµ‹è¯•å…¶ä»–ç‰ˆæœ¬
    
    steps:
      - name: Checkout theme at ${{ matrix.version }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.version }}

      - name: Copy latest .github files from workflow branch
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ä¸­çš„ .github æ–‡ä»¶:"
          ls -la .github/ || echo ".github ç›®å½•ä¸å­˜åœ¨"
          
          # ä¿å­˜å½“å‰ checkout çš„ç‰ˆæœ¬ä¿¡æ¯
          CURRENT_VERSION=$(git describe --tags --exact-match 2>/dev/null || echo "unknown")
          echo "å½“å‰ç‰ˆæœ¬: ${CURRENT_VERSION}"
          
          # åˆ é™¤æ—§çš„ .github ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          rm -rf .github
          
          # ä»å·¥ä½œæµå‘èµ·åˆ†æ”¯è·å–æœ€æ–°çš„ .github é…ç½®å’Œè„šæœ¬
          WORKFLOW_BRANCH="${{ github.ref_name }}"
          echo "å·¥ä½œæµå‘èµ·åˆ†æ”¯: ${WORKFLOW_BRANCH}"
          
          git fetch origin "${WORKFLOW_BRANCH}":"refs/remotes/origin/${WORKFLOW_BRANCH}"
          git checkout "origin/${WORKFLOW_BRANCH}" -- .github
          
          echo "âœ“ å·²ä»å·¥ä½œæµå‘èµ·åˆ†æ”¯ ${WORKFLOW_BRANCH} å¤åˆ¶æœ€æ–°çš„ .github æ–‡ä»¶"
          echo "å¤åˆ¶åçš„ .github æ–‡ä»¶:"
          ls -la .github/scripts/ || echo ".github/scripts ç›®å½•ä¸å­˜åœ¨"

      - name: Check and set pnpm version
        id: check-pnpm
        run: |
          if grep -q "packageManager" package.json; then
            echo "pnpm_version_needed=false" >> $GITHUB_OUTPUT
            echo "âœ“ package.json å·²åŒ…å« packageManager å­—æ®µ"
          else
            echo "pnpm_version_needed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  package.json ä¸åŒ…å« packageManager å­—æ®µï¼Œå°†ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬"
          fi

      - name: Setup pnpm (with version)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm (auto-detect)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'false'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # ========== å¹¶è¡Œæ‰§è¡Œ(ä¸»è¦è€—æ—¶éƒ¨åˆ†) ==========
      - name: Parallel Build Theme and Setup Halo
        shell: bash
        run: |
          set -e
          
          JAVA_VERSION=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "JAVA_VERSION=${JAVA_VERSION}" >> $GITHUB_ENV
          HALO_VERSION="2.21.10"
          echo "HALO_VERSION=${HALO_VERSION}" >> $GITHUB_ENV
          
          mkdir -p ~/logs
          
          # ============ ä»»åŠ¡ 1: ä¸»é¢˜æ„å»º ============
          (
            set -e
            echo "ğŸ“¦ [Theme] å¼€å§‹æ„å»º"
            
            pnpm install
            pnpm build
            
            mkdir -p ~/builds/tmp ~/builds/target
            
            cp -r . ~/builds/tmp
            mkdir -p ~/builds/tmp-included
            cd ~/builds/tmp
            while IFS= read -r item; do
              if [ -e "$item" ]; then
                cp -r --parents "$item" ~/builds/tmp-included/
              fi
            done < ${{ github.workspace }}/.github/include-list.txt
            cd ~/builds/tmp-included
            zip -9 -r howiehz-higan-cn.zip .
            mv howiehz-higan-cn.zip ~/builds/target/
            
            echo "âœ… [Theme] å®Œæˆ"
          ) > ~/logs/theme.log 2>&1 &
          THEME_PID=$!
          
          # ============ ä»»åŠ¡ 2: Halo è®¾ç½® ============
          (
            set -e
            echo "ğŸ”§ [Halo] å¼€å§‹è®¾ç½®"
            
            if ! wget -q "https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar" -O ~/halo.jar; then
              wget -q "https://dl.halo.run/release/halo-${HALO_VERSION}.jar" -O ~/halo.jar
            fi
            
            mkdir -p ~/.halo2
            cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF
            
            nohup java -jar ~/halo.jar \
              --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
              -Dfile.encoding=UTF-8 > ~/logs/halo-startup.log 2>&1 &
            echo $! > ~/halo.pid
            
            for i in {1..60}; do
              if curl -sf http://localhost:8090/actuator/health/readiness >/dev/null 2>&1; then
                echo "âœ… [Halo] å°±ç»ª (${i}æ¬¡å°è¯•)"
                break
              fi
              [ $i -eq 60 ] && { echo "âŒ [Halo] è¶…æ—¶"; cat ~/logs/halo-startup.log; exit 1; }
              sleep 1
            done
            
            echo "æ­£åœ¨åˆå§‹åŒ– Halo ç³»ç»Ÿ..."
            response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
            csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^"]*\)".*/\1/p')
            
            curl -b /tmp/cookies.txt -X POST \
              http://localhost:8090/system/setup \
              -H "Content-Type: application/x-www-form-urlencoded" \
              -d "_csrf=${csrf_token}" \
              -d "language=zh-CN" \
              -d "externalUrl=http://localhost:8090" \
              -d "siteTitle=Test Site" \
              -d "username=admin" \
              -d "email=admin@example.com" \
              -d "password=admin" \
              -d "confirmPassword=admin" \
              -L -s > /dev/null

            echo "âœ… [Halo] å®Œæˆ"
          ) > ~/logs/halo.log 2>&1 &
          HALO_PID=$!
          
          # ============ ç­‰å¾…å¹¶æ£€æŸ¥ç»“æœ ============
          echo "â³ ç­‰å¾…å¹¶è¡Œä»»åŠ¡..."
          
          wait $THEME_PID
          THEME_CODE=$?
          wait $HALO_PID
          HALO_CODE=$?
          
          if [ $THEME_CODE -ne 0 ]; then
            echo "âŒ ä¸»é¢˜æ„å»ºå¤±è´¥"
            cat ~/logs/theme.log
            exit 1
          fi
          
          if [ $HALO_CODE -ne 0 ]; then
            echo "âŒ Halo è®¾ç½®å¤±è´¥"
            cat ~/logs/halo.log
            exit 1
          fi
          
          echo "ğŸ‰ å¹¶è¡Œä»»åŠ¡å…¨éƒ¨æˆåŠŸ!"

      - name: Install and activate theme
        run: |
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "âŒ ä¸»é¢˜æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "å®‰è£…ä¸»é¢˜..."
          curl -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -s > /dev/null
          
          echo "âœ“ ä¸»é¢˜å·²å®‰è£…"

          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ä¸»é¢˜å·²æ¿€æ´»"

          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          
          echo "âœ“ ç¼“å­˜å·²æ¸…é™¤"

      - name: Setup Lighthouse CI
        run: |
          pnpm add -g @lhci/cli@0.15.x
          echo "LHCI_VERSION=$(lhci --version)" >> $GITHUB_ENV

      - name: Run Lighthouse CI
        run: |
          mkdir -p .lighthouseci
          lhci autorun \
            --collect.url=http://localhost:8090/ \
            --collect.url=http://localhost:8090/archives \
            --collect.url=http://localhost:8090/archives/hello-halo \
            --collect.url=http://localhost:8090/tags \
            --collect.url=http://localhost:8090/tags/halo \
            --collect.url=http://localhost:8090/categories \
            --collect.url=http://localhost:8090/categories/default \
            --collect.url=http://localhost:8090/authors/admin \
            --collect.url=http://localhost:8090/about \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --collect.settings.throttling.rttMs=40 \
            --collect.settings.throttling.throughputKbps=10240 \
            --collect.settings.throttling.cpuSlowdownMultiplier=1 \
            --upload.target=filesystem \
            --upload.outputDir=.lighthouseci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Generate report (JSON only)
        run: |
          mkdir -p .github/page_size_audit_results
          node .github/scripts/generate-report.js
        env:
          LIGHTHOUSE_RESULTS_DIR: .lighthouseci
          OUTPUT_DIR: .github/page_size_audit_results
          OUTPUT_FILENAME: ${{ matrix.version }}
          JSON_ONLY: "true"
          HALO_VERSION: ${{ env.HALO_VERSION }}
          JAVA_VERSION: ${{ env.JAVA_VERSION }}
          THEME_VERSION: ${{ matrix.version }}
          LHCI_VERSION: ${{ env.LHCI_VERSION }}

      - name: Upload report for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.version }}
          path: .github/page_size_audit_results/${{ matrix.version }}.json
          retention-days: 1

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.version }}
          path: ~/logs/

  # ç¬¬ä¸‰æ­¥ï¼šæ±‡æ€»æ‰€æœ‰ç‰ˆæœ¬çš„æ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨
  generate-chart:
    name: Generate Chart
    needs: test-versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: ./all-reports

      - name: Copy reports to page_size_audit_results
        if: github.event.inputs.create_pr == 'true' || github.event_name == 'release'
        run: |
          mkdir -p .github/page_size_audit_results
          for dir in ./all-reports/report-*; do
            if [ -d "$dir" ]; then
              version=$(basename "$dir" | sed 's/report-//')
              cp "$dir/${version}.json" ".github/page_size_audit_results/${version}.json"
              echo "âœ“ å¤åˆ¶ ${version}.json"
            fi
          done

      - name: Create PR with data files
        if: github.event.inputs.create_pr == 'true' || github.event_name == 'release'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PR_WORKFLOW_TOKEN }}
          # ä½¿ç”¨ PAT è€Œé GITHUB_TOKENï¼Œä»¥ä¾¿åˆ›å»ºçš„ PR èƒ½è§¦å‘å…¶ä»–å·¥ä½œæµ
          # æ‰€éœ€æƒé™ï¼ˆFine-grained PATï¼‰ï¼š
          # - Contents: Read and Writeï¼ˆåˆ›å»ºåˆ†æ”¯å’Œæäº¤ï¼‰
          # - Pull requests: Read and Writeï¼ˆåˆ›å»º PRï¼‰
          # - Workflows: Read and Writeï¼ˆå…è®¸ PR è§¦å‘å·¥ä½œæµï¼‰
          commit-message: "chore: update page size audit results for ${{ github.event.inputs.start_version || github.event.release.tag_name }} to ${{ github.event.inputs.end_version || github.event.release.tag_name || 'latest' }}"
          title: 'chore: Update Page Size Audit Results'
          body: |
            ## Page Size Audit Results Update
            
            This PR adds/updates page size audit results for versions:
            - **Start Version:** ${{ github.event.inputs.start_version || github.event.release.tag_name }}
            - **End Version:** ${{ github.event.inputs.end_version || github.event.release.tag_name || 'latest' }}
            
            The following JSON data files have been updated in `.github/page_size_audit_results/`:
            - Multiple version result files
            
            These files will be used for generating performance trend charts.
            
            ---
            *Auto-generated by Page Size Audit workflow*
          branch: perf/page-size-audit-${{ github.run_number }}
          delete-branch: true
          labels: performance
          add-paths: .github/page_size_audit_results/*.json
