name: "Page Size Audit: Generate JSON"

on:
  workflow_dispatch:
    inputs:
      start_version:
        description: '起始版本 (例如: v1.45.0，留空表示 v1.0.0)'
        required: false
        default: 'v1.0.0'
      end_version:
        description: '结束版本 (例如: v1.50.0，留空表示最新版本)'
        required: false
        default: ''
      create_pr:
        description: '是否创建 PR 提交数据文件'
        required: true
        default: false
        type: boolean
  release:
    types: [published]

jobs:
  # 第一步：获取要测试的版本列表
  get-versions:
    name: Get Version List
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get version list
        id: get-versions
        uses: actions/github-script@v7
        with:
          script: |
            let startVersion, endVersion;
            
            if ('${{ github.event_name }}' === 'release') {
              const releaseVersion = '${{ github.event.release.tag_name }}';
              startVersion = releaseVersion;
              endVersion = releaseVersion;
              console.log(`Release 触发: 测试版本 ${releaseVersion}`);
            } else {
              startVersion = '${{ github.event.inputs.start_version }}' || 'v1.0.0';
              endVersion = '${{ github.event.inputs.end_version }}' || '';
            }
            
            // 获取所有 releases（支持分页）
            console.log('正在获取所有 releases...');
            const releases = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              releases.push(...data);
              console.log(`已获取第 ${page} 页，共 ${data.length} 个 releases`);
              
              if (data.length < 100) {
                hasMore = false;
              } else {
                page++;
              }
            }
            
            console.log(`总共获取 ${releases.length} 个 releases`);
            
            // 过滤预发布版本（使用 GitHub API 的 prerelease 字段）
            const stableReleases = releases.filter(r => {
              if (r.prerelease) {
                console.log(`⊘ 跳过预发布版本: ${r.tag_name}`);
                return false;
              }
              return true;
            });
            
            console.log(`过滤后得到 ${stableReleases.length} 个稳定版本`);
            
            // 按语义化版本排序（从旧到新）
            const parseVersion = (version) => {
              const match = version.match(/^v?(\d+)\.(\d+)\.(\d+)(?:-(.+))?$/);
              if (!match) return null;
              const [, major, minor, patch] = match;
              return {
                major: parseInt(major, 10),
                minor: parseInt(minor, 10),
                patch: parseInt(patch, 10)
              };
            };
            
            stableReleases.sort((a, b) => {
              const versionA = parseVersion(a.tag_name);
              const versionB = parseVersion(b.tag_name);
              
              if (!versionA || !versionB) {
                console.warn(`⚠️  无法解析版本号: ${a.tag_name} 或 ${b.tag_name}`);
                return 0;
              }
              
              if (versionA.major !== versionB.major) return versionA.major - versionB.major;
              if (versionA.minor !== versionB.minor) return versionA.minor - versionB.minor;
              return versionA.patch - versionB.patch;
            });
            
            // 找到版本范围
            const startIndex = stableReleases.findIndex(r => r.tag_name === startVersion);
            const endIndex = endVersion ? stableReleases.findIndex(r => r.tag_name === endVersion) : stableReleases.length - 1;
            
            if (startIndex === -1) {
              core.setFailed(`找不到起始版本: ${startVersion}，可用的稳定版本: ${stableReleases.slice(0, 10).map(r => r.tag_name).join(', ')}...`);
              return;
            }
            if (endVersion && endIndex === -1) {
              core.setFailed(`找不到结束版本: ${endVersion}`);
              return;
            }
            
            // 提取版本列表（从起始到结束）
            const versionList = stableReleases
              .slice(startIndex, endIndex + 1)
              .map(r => r.tag_name);
            
            console.log(`找到 ${versionList.length} 个版本:`, versionList);
            core.setOutput('versions', JSON.stringify(versionList));

  # 第二步：并行运行每个版本的测试
  test-versions:
    name: Test ${{ matrix.version }}
    needs: get-versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(needs.get-versions.outputs.versions) }}
      fail-fast: false  # 即使某个版本失败，继续测试其他版本
    
    steps:
      - uses: ./.github/workflows/reusable-audit.yml
        with:
          theme_ref: ${{ matrix.version }}
          ref_name: ${{ matrix.version }}
          output_dir: ".github/page_size_audit_results"
          output_filename: ${{ matrix.version }}
          json_only: true

  # 第三步：汇总所有版本的数据并创建 PR
  collect-and-pr:
    name: Collect Reports and Create PR
    needs: test-versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: ./all-reports

      - name: Copy reports to page_size_audit_results
        if: github.event.inputs.create_pr == 'true' || github.event_name == 'release'
        run: |
          mkdir -p .github/page_size_audit_results
          for dir in ./all-reports/report-*; do
            if [ -d "$dir" ]; then
              version=$(basename "$dir" | sed 's/report-//')
              cp "$dir/${version}.json" ".github/page_size_audit_results/${version}.json"
              echo "✓ 复制 ${version}.json"
            fi
          done

      - name: Create PR with data files
        if: github.event.inputs.create_pr == 'true' || github.event_name == 'release'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PR_WORKFLOW_TOKEN }}
          base: main  # main 而不是 github.event_name == 'release' && 'main' || github.ref_name ，是因为目前只提交到 main 更新就够了
          # 使用 PAT 而非 GITHUB_TOKEN，以便创建的 PR 能触发其他工作流
          # 所需权限（Fine-grained PAT）：
          # - Contents: Read and Write（创建分支和提交）
          # - Pull requests: Read and Write（创建 PR）
          # - Workflows: Read and Write（允许 PR 触发工作流）
          commit-message: "chore: update page size audit results for ${{ github.event.inputs.start_version || github.event.release.tag_name }} to ${{ github.event.inputs.end_version || github.event.release.tag_name || 'latest' }}"
          title: 'chore: Update Page Size Audit Results'
          body: |
            ## Page Size Audit Results Update
            
            This PR adds/updates page size audit results for versions:
            - **Start Version:** ${{ github.event.inputs.start_version || github.event.release.tag_name }}
            - **End Version:** ${{ github.event.inputs.end_version || github.event.release.tag_name || 'latest' }}
            
            The following JSON data files have been updated in `.github/page_size_audit_results/`:
            - Multiple version result files
            
            These files will be used for generating performance trend charts.
            
            ---
            *Auto-generated by Page Size Audit workflow*
          branch: perf/page-size-audit-${{ github.run_number }}
          delete-branch: true
          labels: performance
          add-paths: .github/page_size_audit_results/*.json
