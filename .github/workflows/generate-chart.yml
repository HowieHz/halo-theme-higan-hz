name: Generate Size Chart

on:
  workflow_dispatch:
    inputs:
      start_version:
        description: '起始版本 (例如: v1.45.0)'
        required: true
      end_version:
        description: '结束版本 (例如: v1.47.0，留空表示最新版本)'
        required: false
        default: ''
      chart_type:
        description: '图表类型'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - total
          - script-stylesheet
          - all-resources
      create_pr:
        description: '是否创建 PR 提交数据文件'
        required: true
        default: false
        type: boolean

jobs:
  # 第一步：获取要测试的版本列表
  get-versions:
    name: Get Version List
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version list
        id: get-versions
        uses: actions/github-script@v7
        with:
          script: |
            const startVersion = '${{ github.event.inputs.start_version }}';
            const endVersion = '${{ github.event.inputs.end_version }}' || '';
            
            // 获取所有 releases（支持分页）
            console.log('正在获取所有 releases...');
            const releases = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              releases.push(...data);
              console.log(`已获取第 ${page} 页，共 ${data.length} 个 releases`);
              
              if (data.length < 100) {
                hasMore = false;
              } else {
                page++;
              }
            }
            
            console.log(`总共获取 ${releases.length} 个 releases`);
            
            // 找到版本范围
            const startIndex = releases.findIndex(r => r.tag_name === startVersion);
            const endIndex = endVersion ? releases.findIndex(r => r.tag_name === endVersion) : 0;
            
            if (startIndex === -1) {
              core.setFailed(`找不到起始版本: ${startVersion}，可用的版本: ${releases.slice(0, 10).map(r => r.tag_name).join(', ')}...`);
              return;
            }
            if (endVersion && endIndex === -1) {
              core.setFailed(`找不到结束版本: ${endVersion}`);
              return;
            }
            
            // 提取版本列表（从旧到新）
            const versionList = releases
              .slice(endIndex, startIndex + 1)
              .reverse()
              .map(r => r.tag_name);
            
            console.log(`找到 ${versionList.length} 个版本:`, versionList);
            core.setOutput('versions', JSON.stringify(versionList));

  # 第二步：并行运行每个版本的测试
  test-versions:
    name: Test ${{ matrix.version }}
    needs: get-versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(needs.get-versions.outputs.versions) }}
      fail-fast: false  # 即使某个版本失败，继续测试其他版本
    
    steps:
      - name: Checkout theme at ${{ matrix.version }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.version }}

      - name: Copy latest .github files from main branch
        run: |
          # 保存当前分支名
          CURRENT_REF="${{ matrix.version }}"
          
          # 从主分支获取最新的 .github 配置和脚本
          git fetch origin main
          git checkout origin/main -- .github || echo "⚠️  .github not found in main"
          
          echo "✓ 已从主分支复制最新的 .github 文件"

      - name: Check and set pnpm version
        id: check-pnpm
        run: |
          if grep -q "packageManager" package.json; then
            echo "pnpm_version_needed=false" >> $GITHUB_OUTPUT
            echo "✓ package.json 已包含 packageManager 字段"
          else
            echo "pnpm_version_needed=true" >> $GITHUB_OUTPUT
            echo "⚠️  package.json 不包含 packageManager 字段，将使用默认版本"
          fi

      - name: Setup pnpm (with version)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm (auto-detect)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'false'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build theme
        run: pnpm build

      - name: Create build directories
        run: |
          mkdir -p ~/builds/tmp ~/builds/target

      - name: Build theme package
        run: |
          echo "使用当前代码构建主题..."
          cp -r . ~/builds/tmp
          mkdir -p ~/builds/tmp-included
          cd ~/builds/tmp
          cat ${{ github.workspace }}/.github/include-list.txt | xargs -I {} cp -r --parents {} ~/builds/tmp-included/
          cd ~/builds/tmp-included
          zip -9 -r howiehz-higan-cn.zip .
          mv howiehz-higan-cn.zip ~/builds/target/
          echo "✓ 主题构建完成"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Download Halo
        run: |
          HALO_VERSION="2.21.10"
          if wget https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar -O ~/halo.jar 2>/dev/null; then
            echo "✓ 从 GitHub 下载 Halo 成功"
          else
            echo "⚠️  GitHub 下载失败，尝试从备用地址下载..."
            wget https://dl.halo.run/release/halo-${HALO_VERSION}.jar -O ~/halo.jar
            echo "✓ 从备用地址下载 Halo 成功"
          fi

      - name: Create Halo configuration
        run: |
          mkdir -p ~/.halo2
          cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF

      - name: Start Halo in background
        run: |
          nohup java -jar ~/halo.jar \
            --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
            -Dfile.encoding=UTF-8 > ~/halo.log 2>&1 &
          echo $! > ~/halo.pid
          echo "Halo PID: $(cat ~/halo.pid)"

      - name: Wait for Halo to be ready
        run: |
          echo "Waiting for Halo to start..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8090/actuator/health/readiness > /dev/null 2>&1; then
              echo "✓ Halo is ready!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 5
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Halo failed to start"
            cat ~/halo.log
            exit 1
          fi

      - name: Initialize Halo system
        run: |
          echo "正在初始化 Halo 系统..."
          response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
          csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^"]*\)".*/\1/p')
          echo "CSRF Token: $csrf_token"
          curl -b /tmp/cookies.txt -X POST \
            http://localhost:8090/system/setup \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "_csrf=${csrf_token}" \
            -d "language=zh-CN" \
            -d "externalUrl=http://localhost:8090" \
            -d "siteTitle=Test Site" \
            -d "username=admin" \
            -d "email=admin@example.com" \
            -d "password=admin" \
            -d "confirmPassword=admin" \
            -L -v
          echo "✓ Halo 系统初始化完成"
          sleep 10

      - name: Install and activate theme
        run: |
          echo "安装主题..."
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "❌ 主题文件不存在"
            exit 1
          fi
          echo "上传主题文件..."
          curl -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -s > /dev/null
          echo "✓ 主题已安装"
          sleep 3
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          echo "✓ 主题已激活"
          sleep 2
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          echo "✓ 缓存已清除"

      - name: Setup Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.15.x

      - name: Run Lighthouse CI
        run: |
          mkdir -p .lighthouseci
          lhci autorun \
            --collect.url=http://localhost:8090/ \
            --collect.url=http://localhost:8090/archives \
            --collect.url=http://localhost:8090/archives/hello-halo \
            --collect.url=http://localhost:8090/tags \
            --collect.url=http://localhost:8090/tags/halo \
            --collect.url=http://localhost:8090/categories \
            --collect.url=http://localhost:8090/categories/default \
            --collect.url=http://localhost:8090/authors/admin \
            --collect.url=http://localhost:8090/about \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --collect.settings.throttling.rttMs=40 \
            --collect.settings.throttling.throughputKbps=10240 \
            --collect.settings.throttling.cpuSlowdownMultiplier=1 \
            --upload.target=filesystem \
            --upload.outputDir=.lighthouseci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Generate report (JSON only)
        run: |
          mkdir -p .github/page_size_audit_results
          node .github/scripts/generate-report.js
        env:
          LIGHTHOUSE_RESULTS_DIR: .lighthouseci
          OUTPUT_DIR: .github/page_size_audit_results
          OUTPUT_FILENAME: ${{ matrix.version }}
          JSON_ONLY: "true"
          THEME_VERSION: ${{ matrix.version }}

      - name: Upload report for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.version }}
          path: .github/page_size_audit_results/${{ matrix.version }}.json
          retention-days: 1

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

  # 第三步：汇总所有版本的数据并生成图表
  generate-chart:
    name: Generate Chart
    needs: test-versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: ./all-reports

      - name: Copy reports to page_size_audit_results
        if: github.event.inputs.create_pr == 'true'
        run: |
          mkdir -p .github/page_size_audit_results
          # 将所有下载的报告复制到目标目录
          for dir in ./all-reports/report-*; do
            if [ -d "$dir" ]; then
              version=$(basename "$dir" | sed 's/report-//')
              cp "$dir/${version}.json" ".github/page_size_audit_results/${version}.json"
              echo "✓ 复制 ${version}.json"
            fi
          done

      - name: Generate chart from reports
        run: |
          mkdir -p charts
          node .github/scripts/aggregate-and-chart.js
        env:
          REPORTS_DIR: all-reports
          OUTPUT_DIR: charts
          CHART_TYPE: ${{ github.event.inputs.chart_type }}
          START_VERSION: ${{ github.event.inputs.start_version }}
          END_VERSION: ${{ github.event.inputs.end_version }}

      - name: Upload chart
        uses: actions/upload-artifact@v4
        with:
          name: size-chart
          path: ./charts/

      - name: Create issue with charts
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const chartsDir = './charts';
            let body = '';
            
            // Find aggregate chart files only (don't include per-page charts in issue)
            const files = fs.readdirSync(chartsDir);
            const chartFiles = files.filter(f => f.startsWith('size-chart-aggregate-') && f.endsWith('.md')).sort();
            
            if (chartFiles.length > 0) {
              for (const file of chartFiles) {
                const content = fs.readFileSync(path.join(chartsDir, file), 'utf8');
                body += content + '\n\n---\n\n';
              }
              
              const endVersion = '${{ github.event.inputs.end_version }}' || '最新版本';
              const chartType = '${{ github.event.inputs.chart_type }}';
              
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `页面体积趋势图 - ${chartType} (${{ github.event.inputs.start_version }} → ${endVersion})`,
                body: body,
                labels: ['documentation', 'performance']
              });
              
              console.log(`✓ 创建 issue 成功，包含 ${chartFiles.length} 个图表`);
              core.setOutput('issue_number', issue.data.number);
            } else {
              console.log('⚠️  未找到汇总图表文件');
            }

      - name: Create PR with data files
        if: github.event.inputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update page size audit results for ${{ github.event.inputs.start_version }} to ${{ github.event.inputs.end_version || 'latest' }}"
          title: 'chore: Update Page Size Audit Results'
          body: |
            ## Page Size Audit Results Update
            
            This PR adds/updates page size audit results for versions:
            - **Start Version:** ${{ github.event.inputs.start_version }}
            - **End Version:** ${{ github.event.inputs.end_version || 'latest' }}
            
            The following JSON data files have been updated in `.github/page_size_audit_results/`:
            - Multiple version result files
            
            These files will be used for generating performance trend charts.
            
            Related issue: #${{ steps.create-issue.outputs.issue_number }}
            
            ---
            *Auto-generated by Page Size Chart workflow*
          branch: perf/page-size-audit-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            .github/page_size_audit_results/*.json
          labels: |
            performance
            automated
