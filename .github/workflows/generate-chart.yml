name: Generate Size Chart

on:
  workflow_dispatch:
    inputs:
      start_version:
        description: '起始版本 (例如: v1.45.0，留空表示 v1.0.0)'
        required: false
        default: 'v1.0.0'
      end_version:
        description: '结束版本 (例如: v1.47.0，留空表示最新版本)'
        required: false
        default: ''
      chart_type:
        description: '图表类型'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - script-stylesheet
          - all-resources
      create_pr:
        description: '是否创建 PR 提交数据文件'
        required: true
        default: false
        type: boolean

jobs:
  # 第一步：获取要测试的版本列表
  get-versions:
    name: Get Version List
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.get-versions.outputs.versions }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version list
        id: get-versions
        uses: actions/github-script@v7
        with:
          script: |
            const startVersion = '${{ github.event.inputs.start_version }}' || 'v1.0.0';
            const endVersion = '${{ github.event.inputs.end_version }}' || '';
            
            // 获取所有 releases（支持分页）
            console.log('正在获取所有 releases...');
            const releases = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              releases.push(...data);
              console.log(`已获取第 ${page} 页，共 ${data.length} 个 releases`);
              
              if (data.length < 100) {
                hasMore = false;
              } else {
                page++;
              }
            }
            
            console.log(`总共获取 ${releases.length} 个 releases`);
            
            // 过滤预发布版本（使用 GitHub API 的 prerelease 字段）
            const stableReleases = releases.filter(r => {
              if (r.prerelease) {
                console.log(`⊘ 跳过预发布版本: ${r.tag_name}`);
                return false;
              }
              return true;
            });
            
            console.log(`过滤后得到 ${stableReleases.length} 个稳定版本`);
            
            // 按语义化版本排序（从旧到新）
            const parseVersion = (version) => {
              const match = version.match(/^v?(\d+)\.(\d+)\.(\d+)(?:-(.+))?$/);
              if (!match) return null;
              const [, major, minor, patch] = match;
              return {
                major: parseInt(major, 10),
                minor: parseInt(minor, 10),
                patch: parseInt(patch, 10)
              };
            };
            
            stableReleases.sort((a, b) => {
              const versionA = parseVersion(a.tag_name);
              const versionB = parseVersion(b.tag_name);
              
              if (!versionA || !versionB) {
                console.warn(`⚠️  无法解析版本号: ${a.tag_name} 或 ${b.tag_name}`);
                return 0;
              }
              
              if (versionA.major !== versionB.major) return versionA.major - versionB.major;
              if (versionA.minor !== versionB.minor) return versionA.minor - versionB.minor;
              return versionA.patch - versionB.patch;
            });
            
            // 找到版本范围
            const startIndex = stableReleases.findIndex(r => r.tag_name === startVersion);
            const endIndex = endVersion ? stableReleases.findIndex(r => r.tag_name === endVersion) : stableReleases.length - 1;
            
            if (startIndex === -1) {
              core.setFailed(`找不到起始版本: ${startVersion}，可用的稳定版本: ${stableReleases.slice(0, 10).map(r => r.tag_name).join(', ')}...`);
              return;
            }
            if (endVersion && endIndex === -1) {
              core.setFailed(`找不到结束版本: ${endVersion}`);
              return;
            }
            
            // 提取版本列表（从起始到结束）
            const versionList = stableReleases
              .slice(startIndex, endIndex + 1)
              .map(r => r.tag_name);
            
            console.log(`找到 ${versionList.length} 个版本:`, versionList);
            core.setOutput('versions', JSON.stringify(versionList));

  # 第二步：并行运行每个版本的测试
  test-versions:
    name: Test ${{ matrix.version }}
    needs: get-versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: ${{ fromJson(needs.get-versions.outputs.versions) }}
      fail-fast: false  # 即使某个版本失败，继续测试其他版本
    
    steps:
      - name: Checkout theme at ${{ matrix.version }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.version }}

      - name: Copy latest .github files from current branch
        run: |
          # 保存当前分支名
          CURRENT_REF="${{ matrix.version }}"
          
          # 从当前分支获取最新的 .github 配置和脚本
          git fetch origin "${CURRENT_REF}"
          git checkout origin/"${CURRENT_REF}" -- .github || echo "⚠️  .github not found in ${CURRENT_REF}"
          
          echo "✓ 已从当前分支复制最新的 .github 文件"

      - name: Check and set pnpm version
        id: check-pnpm
        run: |
          if grep -q "packageManager" package.json; then
            echo "pnpm_version_needed=false" >> $GITHUB_OUTPUT
            echo "✓ package.json 已包含 packageManager 字段"
          else
            echo "pnpm_version_needed=true" >> $GITHUB_OUTPUT
            echo "⚠️  package.json 不包含 packageManager 字段，将使用默认版本"
          fi

      - name: Setup pnpm (with version)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup pnpm (auto-detect)
        if: steps.check-pnpm.outputs.pnpm_version_needed == 'false'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build theme
        run: pnpm build

      - name: Create build directories
        run: |
          mkdir -p ~/builds/tmp ~/builds/target

      - name: Build theme package
        run: |
          echo "使用当前代码构建主题..."
          cp -r . ~/builds/tmp
          mkdir -p ~/builds/tmp-included
          cd ~/builds/tmp
          # 逐行读取 include-list.txt 并复制存在的文件/文件夹
          while IFS= read -r item; do
            if [ -e "$item" ]; then
              cp -r --parents "$item" ~/builds/tmp-included/
              echo "✓ 复制: $item"
            else
              echo "⚠️  跳过不存在的: $item"
            fi
          done < ${{ github.workspace }}/.github/include-list.txt
          cd ~/builds/tmp-included
          zip -9 -r howiehz-higan-cn.zip .
          mv howiehz-higan-cn.zip ~/builds/target/
          echo "✓ 主题构建完成"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Get Java version
        run: |
          JAVA_VERSION=$(java -version 2>&1 | head -n 1 | awk -F '"' '{print $2}')
          echo "JAVA_VERSION=${JAVA_VERSION}" >> $GITHUB_ENV
          echo "✓ Java 版本: ${JAVA_VERSION}"

      - name: Download Halo
        run: |
          HALO_VERSION="2.21.10"
          if wget https://github.com/halo-dev/halo/releases/download/v${HALO_VERSION}/halo-${HALO_VERSION}.jar -O ~/halo.jar 2>/dev/null; then
            echo "✓ 从 GitHub 下载 Halo 成功"
          else
            echo "⚠️  GitHub 下载失败，尝试从备用地址下载..."
            wget https://dl.halo.run/release/halo-${HALO_VERSION}.jar -O ~/halo.jar
            echo "✓ 从备用地址下载 Halo 成功"
          fi
          # 将实际下载的版本保存到环境变量
          echo "HALO_VERSION=${HALO_VERSION}" >> $GITHUB_ENV
          echo "✓ Halo 版本: ${HALO_VERSION}"

      - name: Create Halo configuration
        run: |
          mkdir -p ~/.halo2
          cat > ~/.halo2/application.yaml << 'EOF'
          server:
            port: 8090
          spring:
            r2dbc:
              url: r2dbc:h2:file:///${user.home}/.halo2/db/halo?MODE=MySQL&DB_CLOSE_ON_EXIT=FALSE
              username: admin
              password: admin
            sql:
              init:
                mode: always
                platform: h2
            thymeleaf:
              cache: true
          halo:
            security:
              basic-auth:
                disabled: false
            work-dir: ${user.home}/.halo2
            external-url: http://localhost:8090
          EOF

      - name: Start Halo in background
        run: |
          nohup java -jar ~/halo.jar \
            --spring.config.additional-location=optional:file:${HOME}/.halo2/ \
            -Dfile.encoding=UTF-8 > ~/halo.log 2>&1 &
          echo $! > ~/halo.pid
          echo "Halo PID: $(cat ~/halo.pid)"

      - name: Wait for Halo to be ready
        run: |
          echo "Waiting for Halo to start..."
          max_attempts=60
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:8090/actuator/health/readiness > /dev/null 2>&1; then
              echo "✓ Halo is ready!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Waiting... ($attempt/$max_attempts)"
            sleep 5
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "❌ Halo failed to start"
            cat ~/halo.log
            exit 1
          fi

      - name: Initialize Halo system
        run: |
          echo "正在初始化 Halo 系统..."
          response=$(curl -c /tmp/cookies.txt -s http://localhost:8090/system/setup)
          csrf_token=$(echo "$response" | grep '_csrf' | sed -n 's/.*value="\([^"]*\)".*/\1/p')
          echo "CSRF Token: $csrf_token"
          curl -b /tmp/cookies.txt -X POST \
            http://localhost:8090/system/setup \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "_csrf=${csrf_token}" \
            -d "language=zh-CN" \
            -d "externalUrl=http://localhost:8090" \
            -d "siteTitle=Test Site" \
            -d "username=admin" \
            -d "email=admin@example.com" \
            -d "password=admin" \
            -d "confirmPassword=admin" \
            -L -v
          echo "✓ Halo 系统初始化完成"
          sleep 10

      - name: Install and activate theme
        run: |
          echo "安装主题..."
          THEME_ZIP_PATH="${HOME}/builds/target/howiehz-higan-cn.zip"
          if [ ! -f "$THEME_ZIP_PATH" ]; then
            echo "❌ 主题文件不存在"
            exit 1
          fi
          echo "上传主题文件..."
          curl -X POST \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/install \
            -u admin:admin \
            -F "file=@${THEME_ZIP_PATH}" \
            -s > /dev/null
          echo "✓ 主题已安装"
          sleep 3
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/activation \
            -u admin:admin \
            -s > /dev/null
          echo "✓ 主题已激活"
          sleep 2
          curl -X PUT \
            http://localhost:8090/apis/api.console.halo.run/v1alpha1/themes/howiehz-higan/invalidate-cache \
            -u admin:admin \
            -s > /dev/null
          echo "✓ 缓存已清除"

      - name: Setup Lighthouse CI
        run: |
          pnpm add -g @lhci/cli@0.15.x
          echo "LHCI_VERSION=$(lhci --version)" >> $GITHUB_ENV

      - name: Run Lighthouse CI
        run: |
          mkdir -p .lighthouseci
          lhci autorun \
            --collect.url=http://localhost:8090/ \
            --collect.url=http://localhost:8090/archives \
            --collect.url=http://localhost:8090/archives/hello-halo \
            --collect.url=http://localhost:8090/tags \
            --collect.url=http://localhost:8090/tags/halo \
            --collect.url=http://localhost:8090/categories \
            --collect.url=http://localhost:8090/categories/default \
            --collect.url=http://localhost:8090/authors/admin \
            --collect.url=http://localhost:8090/about \
            --collect.numberOfRuns=1 \
            --collect.settings.preset=desktop \
            --collect.settings.throttling.rttMs=40 \
            --collect.settings.throttling.throughputKbps=10240 \
            --collect.settings.throttling.cpuSlowdownMultiplier=1 \
            --upload.target=filesystem \
            --upload.outputDir=.lighthouseci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Generate report (JSON only)
        run: |
          mkdir -p .github/page_size_audit_results
          node .github/scripts/generate-report.js
        env:
          LIGHTHOUSE_RESULTS_DIR: .lighthouseci
          OUTPUT_DIR: .github/page_size_audit_results
          OUTPUT_FILENAME: ${{ matrix.version }}
          JSON_ONLY: "true"
          HALO_VERSION: ${{ env.HALO_VERSION }}
          JAVA_VERSION: ${{ env.JAVA_VERSION }}
          THEME_VERSION: ${{ matrix.version }}
          LHCI_VERSION: ${{ env.LHCI_VERSION }}

      - name: Upload report for ${{ matrix.version }}
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.version }}
          path: .github/page_size_audit_results/${{ matrix.version }}.json
          retention-days: 1

      - name: Stop Halo
        if: always()
        run: |
          if [ -f ~/halo.pid ]; then
            kill $(cat ~/halo.pid) || true
          fi

  # 第三步：汇总所有版本的数据并生成图表
  generate-chart:
    name: Generate Chart
    needs: test-versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: report-*
          path: ./all-reports

      - name: Copy reports to page_size_audit_results
        if: github.event.inputs.create_pr == 'true'
        run: |
          mkdir -p .github/page_size_audit_results
          # 将所有下载的报告复制到目标目录
          for dir in ./all-reports/report-*; do
            if [ -d "$dir" ]; then
              version=$(basename "$dir" | sed 's/report-//')
              cp "$dir/${version}.json" ".github/page_size_audit_results/${version}.json"
              echo "✓ 复制 ${version}.json"
            fi
          done

      - name: Generate chart from reports
        run: |
          mkdir -p charts
          node .github/scripts/average-and-chart.js
        env:
          REPORTS_DIR: all-reports
          OUTPUT_DIR: charts
          CHART_TYPE: ${{ github.event.inputs.chart_type }}
          START_VERSION: ${{ github.event.inputs.start_version }}
          END_VERSION: ${{ github.event.inputs.end_version }}

      - name: Upload chart
        uses: actions/upload-artifact@v4
        with:
          name: size-chart
          path: ./charts/

      - name: Create PR with data files
        if: github.event.inputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update page size audit results for ${{ github.event.inputs.start_version }} to ${{ github.event.inputs.end_version || 'latest' }}"
          title: 'chore: Update Page Size Audit Results'
          body: |
            ## Page Size Audit Results Update
            
            This PR adds/updates page size audit results for versions:
            - **Start Version:** ${{ github.event.inputs.start_version }}
            - **End Version:** ${{ github.event.inputs.end_version || 'latest' }}
            
            The following JSON data files have been updated in `.github/page_size_audit_results/`:
            - Multiple version result files
            
            These files will be used for generating performance trend charts.
            
            ---
            *Auto-generated by Page Size Chart workflow*
          branch: perf/page-size-audit-${{ github.run_number }}
          delete-branch: true
          add-paths: |
            .github/page_size_audit_results/*.json
          labels: |
            performance
            automated
