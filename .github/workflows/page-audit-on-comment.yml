name: Page Audit (Issue Comment Triggered)

on:
  issue_comment:
    types: [created]

jobs:
  # Check comment permissions and trigger conditions
  check-trigger:
    name: Check Trigger Conditions
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/audit')
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.pr.outputs.number }}
      pr_head_sha: ${{ steps.pr.outputs.head_sha }}
      pr_head_ref: ${{ steps.pr.outputs.head_ref }}
      comment_id: ${{ github.event.comment.id }}
    
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
      
      - name: Check if commenter has write access
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.comment.user.login
              });
              
              const hasWriteAccess = ['admin', 'write'].includes(permission.permission);
              
              if (!hasWriteAccess) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: '‚ùå You do not have permission to trigger this workflow. Only repository collaborators can use the `/audit` command.'
                });
                core.setOutput('should_run', 'false');
                return;
              }
              
              core.setOutput('should_run', 'true');
            } catch (error) {
              core.setFailed(`Permission check failed: ${error.message}`);
            }
      
      - name: Get PR details
        if: steps.check.outputs.should_run == 'true'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('number', pr.number);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            
            console.log(`PR #${pr.number}`);
            console.log(`Head SHA: ${pr.head.sha}`);
            console.log(`Head Ref: ${pr.head.ref}`);

  # Get latest release version
  get-latest-release:
    name: Get Latest Release
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.release.outputs.tag }}
      release_sha: ${{ steps.release.outputs.sha }}
    
    steps:
      - name: Get latest release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: release } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              core.setOutput('tag', release.tag_name);
              
              // Get the commit SHA for the release tag
              const { data: tag } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${release.tag_name}`
              });
              
              core.setOutput('sha', tag.object.sha);
              
              console.log(`Latest Release: ${release.tag_name}`);
              console.log(`Release SHA: ${tag.object.sha}`);
            } catch (error) {
              if (error.status === 404) {
                core.setFailed('No release found. Ensure the repository has at least one release.');
              } else {
                core.setFailed(`Failed to get latest release: ${error.message}`);
              }
            }

  # Performance test
  audit:
    name: Lighthouse Page Audit (${{ matrix.ref_name }})
    needs: [check-trigger, get-latest-release]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ref_name: current
            ref: ${{ needs.check-trigger.outputs.pr_head_sha }}
          - ref_name: latest-release
            ref: ${{ needs.get-latest-release.outputs.release_sha }}
      fail-fast: false
    
    steps:
      - uses: ./.github/workflows/reusable-audit.yml
        with:
          theme_ref: ${{ matrix.ref }}
          ref_name: ${{ matrix.ref_name }}
          run_lighthouse_ci: true

  # Compare and comment
  compare-and-comment:
    name: Compare and Comment
    needs: [check-trigger, get-latest-release, audit]
    if: |
      always() &&
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.audit.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.pr_head_sha }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
      
      - name: Download current reports
        uses: actions/download-artifact@v7
        with:
          name: page-size-reports-current-comment
          path: ./reports-current
      
      - name: Download latest-release reports
        uses: actions/download-artifact@v7
        with:
          name: page-size-reports-latest-release-comment
          path: ./reports-latest-release
      
      - name: Generate comparison report
        run: |
          node .github/scripts/compare-reports.js
        env:
          CURRENT_REPORT: ./reports-current/page-size-report.json
          BASE_REPORT: ./reports-latest-release/page-size-report.json
          OUTPUT_FILE: ./comparison-report.md
      
      - name: Add header to report
        run: |
          RELEASE_TAG="${{ needs.get-latest-release.outputs.release_tag }}"
          PR_SHA="${{ needs.check-trigger.outputs.pr_head_sha }}"
          
          cat > ./final-report.md << EOF
          # üìä Performance Comparison Report
          
          **Comparison:** Current PR version vs Latest Release version (\`${RELEASE_TAG}\`)
          
          - **Current PR**: [\`${PR_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${PR_SHA})
          - **Latest Release**: [\`${RELEASE_TAG}\`](https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG})
          
          ---
          
          EOF
          
          cat ./comparison-report.md >> ./final-report.md
      
      - name: Add success reaction and comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('./final-report.md', 'utf8');
            
            // Add success reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ needs.check-trigger.outputs.comment_id }},
              content: '+1'
            });
            
            // Post comment
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.check-trigger.outputs.pr_number }},
                body: report
              });
              console.log('‚úì Performance comparison report posted successfully');
            } catch (error) {
              if (error.status === 403) {
                console.log('‚ö†Ô∏è Cannot post comment (insufficient permissions).');
                console.log('üìä The report has been generated and uploaded as an artifact; it can be viewed manually.');
              } else {
                throw error;
              }
            }
  
  # Handle failure cases
  handle-failure:
    name: Handle Failure
    needs: [check-trigger, audit]
    if: |
      always() &&
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.audit.result == 'failure'
    runs-on: ubuntu-latest
    
    steps:
      - name: Add failure reaction and comment
        uses: actions/github-script@v7
        with:
          script: |
            // Add failure reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ needs.check-trigger.outputs.comment_id }},
              content: '-1'
            });
            
            // Post failure notification
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: '‚ùå Performance tests failed. See the [workflow run logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            });
