name: Page Audit (Comment Triggered)

on:
  issue_comment:
    types: [created]

jobs:
  # æ£€æŸ¥è¯„è®ºæƒé™å’Œè§¦å‘æ¡ä»¶
  check-trigger:
    name: Check Trigger Conditions
    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/audit')
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.pr.outputs.number }}
      pr_head_sha: ${{ steps.pr.outputs.head_sha }}
      pr_head_ref: ${{ steps.pr.outputs.head_ref }}
      comment_id: ${{ github.event.comment.id }}
    
    steps:
      - name: Add reaction to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
      
      - name: Check if commenter has write access
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.comment.user.login
              });
              
              const hasWriteAccess = ['admin', 'write'].includes(permission.permission);
              
              if (!hasWriteAccess) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: 'âŒ ä½ æ²¡æœ‰æƒé™è§¦å‘æ­¤ workflowã€‚åªæœ‰ä»“åº“åä½œè€…å¯ä»¥ä½¿ç”¨ `/audit` å‘½ä»¤ã€‚'
                });
                core.setOutput('should_run', 'false');
                return;
              }
              
              core.setOutput('should_run', 'true');
            } catch (error) {
              core.setFailed(`æ£€æŸ¥æƒé™å¤±è´¥: ${error.message}`);
            }
      
      - name: Get PR details
        if: steps.check.outputs.should_run == 'true'
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            core.setOutput('number', pr.number);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('head_ref', pr.head.ref);
            
            console.log(`PR #${pr.number}`);
            console.log(`Head SHA: ${pr.head.sha}`);
            console.log(`Head Ref: ${pr.head.ref}`);

  # è·å–æœ€æ–° release ç‰ˆæœ¬
  get-latest-release:
    name: Get Latest Release
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.release.outputs.tag }}
      release_sha: ${{ steps.release.outputs.sha }}
    
    steps:
      - name: Get latest release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: release } = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              core.setOutput('tag', release.tag_name);
              
              // è·å– release tag å¯¹åº”çš„ commit SHA
              const { data: tag } = await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${release.tag_name}`
              });
              
              core.setOutput('sha', tag.object.sha);
              
              console.log(`Latest Release: ${release.tag_name}`);
              console.log(`Release SHA: ${tag.object.sha}`);
            } catch (error) {
              if (error.status === 404) {
                core.setFailed('æ²¡æœ‰æ‰¾åˆ° release ç‰ˆæœ¬ã€‚è¯·ç¡®ä¿ä»“åº“è‡³å°‘æœ‰ä¸€ä¸ª releaseã€‚');
              } else {
                core.setFailed(`è·å–æœ€æ–° release å¤±è´¥: ${error.message}`);
              }
            }

  # æ€§èƒ½æµ‹è¯•
  audit:
    name: Lighthouse Performance Audit (${{ matrix.ref_name }})
    needs: [check-trigger, get-latest-release]
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - ref_name: current
            ref: ${{ needs.check-trigger.outputs.pr_head_sha }}
          - ref_name: latest-release
            ref: ${{ needs.get-latest-release.outputs.release_sha }}
      fail-fast: false
    
    steps:
      - uses: ./.github/workflows/reusable-audit.yml
        with:
          theme_ref: ${{ matrix.ref }}
          ref_name: ${{ matrix.ref_name }}

  # å¯¹æ¯”å’Œè¯„è®º
  compare-and-comment:
    name: Compare and Comment
    needs: [check-trigger, get-latest-release, audit]
    if: |
      always() &&
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.audit.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.check-trigger.outputs.pr_head_sha }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
      
      - name: Download current reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-current-comment
          path: ./reports-current
      
      - name: Download latest-release reports
        uses: actions/download-artifact@v4
        with:
          name: page-size-reports-latest-release-comment
          path: ./reports-latest-release
      
      - name: Generate comparison report
        run: |
          node .github/scripts/compare-reports.js
        env:
          CURRENT_REPORT: ./reports-current/page-size-report.json
          BASE_REPORT: ./reports-latest-release/page-size-report.json
          OUTPUT_FILE: ./comparison-report.md
      
      - name: Add header to report
        run: |
          RELEASE_TAG="${{ needs.get-latest-release.outputs.release_tag }}"
          PR_SHA="${{ needs.check-trigger.outputs.pr_head_sha }}"
          
          cat > ./final-report.md << EOF
          # ğŸ“Š Performance Comparison Report
          
          **Comparison:** Current PR version vs Latest Release version (\`${RELEASE_TAG}\`)
          
          - **Current PR**: [\`${PR_SHA:0:7}\`](https://github.com/${{ github.repository }}/commit/${PR_SHA})
          - **Latest Release**: [\`${RELEASE_TAG}\`](https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG})
          
          ---
          
          EOF
          
          cat ./comparison-report.md >> ./final-report.md
      
      - name: Add success reaction and comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('./final-report.md', 'utf8');
            
            // æ·»åŠ æˆåŠŸååº”
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ needs.check-trigger.outputs.comment_id }},
              content: '+1'
            });
            
            // å‘å¸ƒè¯„è®º
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.check-trigger.outputs.pr_number }},
                body: report
              });
              console.log('âœ“ æˆåŠŸå‘å¸ƒæ€§èƒ½å¯¹æ¯”æŠ¥å‘Š');
            } catch (error) {
              if (error.status === 403) {
                console.log('âš ï¸  æ— æ³•å‘å¸ƒè¯„è®ºï¼ˆæƒé™ä¸è¶³ï¼‰');
                console.log('ğŸ“Š æŠ¥å‘Šå·²ç”Ÿæˆå¹¶ä¸Šä¼ ä¸º artifactï¼Œå¯ä»¥æ‰‹åŠ¨æŸ¥çœ‹');
              } else {
                throw error;
              }
            }
  
  # å¤„ç†å¤±è´¥æƒ…å†µ
  handle-failure:
    name: Handle Failure
    needs: [check-trigger, audit]
    if: |
      always() &&
      needs.check-trigger.outputs.should_run == 'true' &&
      needs.audit.result == 'failure'
    runs-on: ubuntu-latest
    
    steps:
      - name: Add failure reaction and comment
        uses: actions/github-script@v7
        with:
          script: |
            // æ·»åŠ å¤±è´¥ååº”
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ needs.check-trigger.outputs.comment_id }},
              content: '-1'
            });
            
            // å‘å¸ƒå¤±è´¥é€šçŸ¥
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-trigger.outputs.pr_number }},
              body: 'âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥ã€‚è¯·æŸ¥çœ‹ [workflow è¿è¡Œæ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚'
            });
