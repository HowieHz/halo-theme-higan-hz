name: Build Theme
on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  build:
    name: Build and Upload Theme
    runs-on: ubuntu-latest
    steps:
      - name: Make Build Directory
        run: |
          pwd
          mkdir -p ~/builds/tmp ~/builds/target

      - name: Checkout
        uses: actions/checkout@v6

      - name: Detect package manager in package.json
        id: detect-pm
        run: |
          pm=""
          if [ -f package.json ]; then
            # If packageManager value starts with pnpm@, extract the full pnpm@... token
            if grep -Eq '"packageManager"[[:space:]]*:[[:space:]]*"[[:space:]]*pnpm@' package.json; then
              pm=$(sed -n 's/.*"packageManager"[[:space:]]*:[[:space:]]*"[[:space:]]*\(pnpm@[^"]*\)".*/\1/p' package.json || true)
            fi
          fi
          echo "pm=${pm}" >> $GITHUB_OUTPUT

      - name: Setup pnpm (normal, when packageManager declares pnpm)
        if: ${{ steps.detect-pm.outputs.pm != '' && contains(steps.detect-pm.outputs.pm, 'pnpm') }}
        uses: pnpm/action-setup@v4

      - name: Setup pnpm (fallback when packageManager missing)
        if: ${{ steps.detect-pm.outputs.pm == '' }}
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build project (with memory diagnostics)
        run: |
          set -o pipefail
          echo "=== Runtime ==="
          node -v
          pnpm -v
          echo "CI=${CI}"
          echo "=== Host Memory ==="
          free -h || true
          echo "=== Cgroup Memory Limit ==="
          if [ -f /sys/fs/cgroup/memory.max ]; then
            cat /sys/fs/cgroup/memory.max
          fi
          if [ -f /sys/fs/cgroup/memory/memory.limit_in_bytes ]; then
            cat /sys/fs/cgroup/memory/memory.limit_in_bytes
          fi
          echo "=== Build Start ==="
          /usr/bin/time -v env NODE_OPTIONS="--max-old-space-size=6144" pnpm build 2>&1 | tee build.log

      - name: OOM diagnostics (on failure)
        if: failure()
        run: |
          echo "=== OOM Diagnostics ==="
          free -h || true
          if [ -f /sys/fs/cgroup/memory.current ]; then
            echo "cgroup memory.current:"
            cat /sys/fs/cgroup/memory.current
          fi
          if [ -f /sys/fs/cgroup/memory.events ]; then
            echo "cgroup memory.events:"
            cat /sys/fs/cgroup/memory.events
          fi
          echo "dmesg OOM tail:"
          dmesg -T | grep -Ei 'killed process|out of memory|oom' | tail -n 50 || true
          if [ -f build.log ]; then
            echo "--- build.log tail ---"
            tail -n 200 build.log
          fi

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          if-no-files-found: ignore

      - name: Write build memory summary
        if: always()
        run: |
          echo "## Build Memory" >> $GITHUB_STEP_SUMMARY
          if [ -f build.log ]; then
            rss=$(grep -E "Maximum resident set size" build.log | tail -n 1 | sed -E 's/.*: *//')
            if [ -n "$rss" ]; then
              echo "- Max RSS (KB): ${rss}" >> $GITHUB_STEP_SUMMARY
            else
              echo "- Max RSS: not found in build.log" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- build.log not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Copy Theme Files from Original to Temp
        run: |
          pwd
          cp -r . ~/builds/tmp

      - name: Keep only included files
        run: |
          pwd
          cd ~/builds/tmp
          pwd
          mkdir ~/builds/tmp-included
          cat ~/work/halo-theme-higan-hz/halo-theme-higan-hz/.github/include-list.txt | xargs -I {} cp -r --parents {} ~/builds/tmp-included
          rm -rf ~/builds/tmp
          mv ~/builds/tmp-included ~/builds/tmp

      - name: Zip Theme in Chinese
        run: |
          pwd
          cd ~/builds/tmp
          pwd

          zip -9 -r howiehz-higan-cn.zip .

          rm settings.yaml annotation-settings.yaml theme.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/settings.yaml settings.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/annotation-settings.yaml annotation-settings.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/theme.yaml theme.yaml
          zip -9 -r howiehz-higan-cn.zip settings.yaml annotation-settings.yaml theme.yaml

          mv howiehz-higan-cn.zip ~/builds/target

      - name: Zip Theme in English
        run: |
          pwd
          cd ~/builds/tmp
          pwd

          zip -9 -r howiehz-higan-en.zip .

          rm settings.yaml annotation-settings.yaml theme.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/i18n-settings/settings.en.yaml settings.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/i18n-settings/annotation-settings.en.yaml annotation-settings.yaml
          mv ~/work/halo-theme-higan-hz/halo-theme-higan-hz/i18n-settings/theme.en.yaml theme.yaml
          zip -9 -r howiehz-higan-en.zip settings.yaml annotation-settings.yaml theme.yaml

          mv howiehz-higan-en.zip ~/builds/target

      - name: Upload Theme Build Target
        uses: actions/upload-artifact@v4
        with:
          name: theme-artifact
          path: ~/builds/target/*
